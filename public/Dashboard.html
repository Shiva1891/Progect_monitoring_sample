<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AGTEK: Project Monitoring</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Authorization script -->
    <script>
        // Only one user with password
        const users = {
            allocate: {
                password: "2025",
                role: "allocate"
            }
        };

        function login() {
            const username = "allocate";   // fixed username
            const pass = document.getElementById("password").value;

            // Check password
            if (pass !== users[username].password) {
                alert("Invalid password");
                return;
            }

            // Save login status
            localStorage.setItem("auth", "yes");
            localStorage.setItem("role", users[username].role);

            // Redirect based on role
            if (users[username].role === "allocate") {
                window.location.href = "Allocate.html";
            } else {
                window.location.href = "access-denied.html";
            }
        }
        function allocate() {
            document.getElementById("allocate").classList.remove("hidden");
        }

    </script>
    
    <script>
        const allNames = [];

        function extractNamesFromObject(obj) {
            return Object.keys(obj)
                .filter(k => k.startsWith("name") && obj[k])
                .map(k => obj[k]);
        }

        function extractNamesByProcess(emp, column, processId) {
            const result = [];

            const arr = emp[column];
            if (!Array.isArray(arr)) return result;

            arr.forEach(obj => {
                Object.keys(obj).forEach(k => {
                    if (k.startsWith("user_type_") && obj[k] === processId) {
                        const index = k.split("_")[2] || k.split("_")[1];
                        const nameKey = `name_${index}`;

                        if (obj[nameKey]) {
                            result.push(obj[nameKey]);
                        }
                    }
                });
            });

            return result;
        }


        function extractNamesFromEmployeeRecord(record) {
            const names = [];

            ["designers_name"].forEach(col =>{
                const data = record[col];

                if (!Array.isArray(data)) return;

                data.forEach(item => {
                    const extracted = extractNamesFromObject(item);
                    names.push(...extracted);
                });
            });

            return names;
        }

        function loaddesigners() {
            const userBtn = document.getElementById("userMenuBtn");
            const dropdown = document.getElementById("userDropdown");

            userBtn.addEventListener("click", () => {
                dropdown.classList.toggle("hidden");
                closeSidebar();

                // Load only when opening
                if (dropdown.classList.contains("hidden")) return;

                fetch(`/employee`)
                    .then(res => res.json())
                    .then(data => {

                        const allNames = [];

                        data.forEach(record => {
                            const names = extractNamesFromEmployeeRecord(record);
                            allNames.push(...names);
                        });

                        const uniqueNames = [...new Set(allNames)];

                        console.log(uniqueNames);
                        // ["SEKAR", "BALAJI-DE", "NIRMAL"]
                   

                        dropdown.innerHTML = "";

                        let listHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg w-80 relative items-center">
                    <div class="flex gap-2 justify-between items-center">
                        <h1 class="text-xl font-semibold">Designers</h1>
                        <div class="py-2">
                            <button onclick="closetype()"
                                class="rounded text-white bg-red-500 hover:bg-red-600 px-2 pb-1">
                                x
                            </button>
                        </div>
                    </div>
                    <ul class="bg-green-100 py-2 px-2 rounded-2xl shadow">`;

                        uniqueNames.forEach(name => {
                            listHTML += `
                        <li>
                            <a class="designer-item block px-4 py-2 hover:bg-green-200 font-semibold cursor-pointer"
                               data-name="${name}">
                               ${name}
                            </a>
                        </li>`;
                        });

                        listHTML += `</ul></div>`;
                        dropdown.innerHTML = listHTML;

                        document.querySelectorAll(".designer-item").forEach(item => {
                            item.addEventListener("click", () => {
                                const name = item.dataset.name;

                                localStorage.setItem("selectedDesigner", name);
                                window.location.href = "login";
                                dropdown.classList.add("hidden");
                            });
                        });
                    })
                    .catch(err => {
                        dropdown.innerHTML =
                            `<div class="p-4 text-red-600">API Error: ${err}</div>`;
                    });
            });

            // close when clicking outside
            document.addEventListener("click", (e) => {
                if (!userBtn.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add("hidden");
                }
            });
        }

        

        function loadprocesses() {
            const selectedprocessname = processId.trim().toUpperCase();
            const vmcDropdown = document.getElementById("vmcDropdown");
            vmcDropdown.innerHTML = "";
            vmcDropdown.classList.remove("hidden");

            fetch(`/employee`)
                .then(res => res.json())
                .then(data => {

                    const names = [];

                    data.forEach(emp => {
                        if (!Array.isArray(emp.employee_names)) return;

                        emp.employee_names.forEach(p => {
                            if (p.user_type === selectedprocessname && p.name) {
                                names.push(p.name);
                            }
                        });
                    });

                    const unique = [...new Set(names)];

                    let listHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg w-80 relative">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-xl font-semibold">${selectedprocessname}</h1>
                    <button onclick="closetype()"
                        class="rounded text-white bg-red-500 hover:bg-red-600 px-2 pb-1">x</button>
                </div>

                <ul class="bg-green-100 py-2 px-2 rounded-2xl shadow">`;

                    if (names.length === 0) {
                        listHTML += `
                    <li class="px-4 py-2 text-gray-500">
                        No users found
                    </li>`;
                    } else {
                        names.forEach(name => {
                            listHTML += `
                        <li>
                            <a class="process-item block px-4 py-2 hover:bg-green-200
                               font-semibold cursor-pointer rounded-2xl"
                               data-name="${name}">
                               ${name}
                            </a>
                        </li>`;
                        });
                    }

                    listHTML += `</ul></div>`;
                    vmcDropdown.innerHTML = listHTML;

                    // click event
                    vmcDropdown.querySelectorAll(".process-item").forEach(item => {
                        item.onclick = () => {
                            const name = item.dataset.name;
                            localStorage.setItem("selectedDesigner", name);
                            window.location.href = "login.html";
                        };
                    });
                })
                .catch(err => {
                    vmcDropdown.innerHTML =
                        `<div class="p-4 text-red-600">API Error: ${err}</div>`;
                });
        }
        let processId = [];
        let currentSection = null;
        let currentBtn = null;
        function updatestatus(processName, btn) {
             
            const manufacturing = document.getElementById("manufacturing");
            const sectionId = processName.toLowerCase();
            const section = document.getElementById(sectionId);

            if (!section) {
                console.warn("This process has no HTML section:", sectionId);
                return;
            }

            // Toggle same section
            if (currentSection === section) {
                section.classList.add("hidden");
                manufacturing.classList.remove("hidden");
                btn.classList.remove("bg-green-200");
                currentSection = null;
                currentBtn = null;   // 👈 reset
                return;
            }

            if (currentSection) currentSection.classList.add("hidden");
            if (currentBtn) currentBtn.classList.remove("bg-green-200");

            manufacturing.classList.add("hidden");
            section.classList.remove("hidden");
            btn.classList.add("bg-green-200");

            if (
                processName !== "DESIGN" &&
                processName !== "DFM" &&
                processName !== "FINISH" &&
                processName !== "ASSEMBLY" &&
                processName !== "DELIVERY"
            ) {
                loadProcessPage(processName, sectionId + "Container");
            }

            closeSidebar();

            currentSection = section;
            currentBtn = btn;   // 👈 store active button
        }
        let processBtn = null;
        let currentprocess = null;
        function operatorpage(processName, pbtn) {
            
            const manufacturing = document.getElementById("manufacturing");
            processId = (processName).toLowerCase();
            const process = document.getElementById(processId);

            if (!process) {
                console.warn("This process has no HTML process:", processId);
                return;
            }

            if (processBtn) processBtn.classList.remove("bg-green-500");

            pbtn.classList.add("bg-green-500");
            closeSidebar();
            currentprocess = process;
            loadprocesses();
            processBtn = pbtn;   // 👈 store active button
        }

        // ✅ pre set project status
        function overallstatus(id, jobno) {
            selectitem = id;
            selectjob = jobno;
            document.getElementById("status").classList.remove("hidden");

        }

        // ✅ pre set project status at LINE
        function setpriority() {
            if (!selectitem) return alert("No ID selected!");
            fetch(`/projects/${selectitem}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ jobno: selectjob, overallstatus: "PRIORITY" })
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Updated:", data);

                    // Optional: Show updated on screen
                    alert(`ID ${selectitem} status updated to ${data.newStatus}`);
                }).then(loadAPI)
                .catch(err => console.error(err));
            document.getElementById("status").classList.add("hidden");

        }

        function addproject() {
            closeSidebar();
            document.getElementById("projecttype").classList.remove("hidden");
        }
        let selectprojecttype = [];

        function rework() {
            selectprojecttype = "REWORK";
            document.getElementById("showrework").classList.remove("hidden");
            document.getElementById("repeatordertype").classList.add("hidden");
            document.getElementById("projecttype").classList.add("hidden");
            document.getElementById("reworktype").classList.remove("hidden");
            document.getElementById("reworkjobnoInput").value = "";
            clearall();
        }

        function repeatorder() {
            selectprojecttype = "REPEAT_ORDER";
            document.getElementById("showrework").classList.remove("hidden");
            document.getElementById("repeatordertype").classList.remove("hidden");
            document.getElementById("reworktype").classList.add("hidden");
            document.getElementById("projecttype").classList.add("hidden");
            document.getElementById("reworkjobnoInput").value = "";
            clearall();
            document.getElementById("customerInput").readOnly = true;
            document.getElementById("reworkprojectname").readOnly = true;
            document.getElementById("reworkcontactperson").readOnly = true;
        }

        // ✅ New Project
        function newproject() {

            selectprojecttype = "NEW_JOB";
            document.getElementById("projecttype").classList.add("hidden");
            document.getElementById("project").classList.remove("hidden");
            document.getElementById("vmcDropdown").classList.add("hidden");

            // Reset input fields (only those that exist)
            document.getElementById("projectname").value = "";
            document.getElementById("contactperson").value = "";
            document.getElementById("parchaseqty").value = "";
            document.getElementById("toDate").value = "";
            document.getElementById("newjobno").value = "";
            document.getElementById("newcustomername").value = "";

            loadcustomers();
        }

        // ✅ create Project
        function autoAddWithSequence(existingArray, keyPrefix, value) {
            let arr = [];

            // normalize existing array
            if (existingArray) {
                if (typeof existingArray === "string") {
                    arr = JSON.parse(existingArray);
                } else if (Array.isArray(existingArray)) {
                    arr = [...existingArray];
                }
            }

            const nextIndex = arr.length + 1;
            arr.push({ [`${keyPrefix}_${nextIndex}`]: value });

            return arr;
        }

        function createp() {
            const customername = document.getElementById("newcustomername").value.trim();
            const projectname = document.getElementById("projectname").value.trim();
            const parchaseqty = Number(document.getElementById("parchaseqty").value);
            const newjobno = document.getElementById("newjobno").value.trim().toUpperCase();
            const contactperson = document.getElementById("contactperson").value.trim();
            const todate = document.getElementById("toDate").value;

            // Validation
            if (!customername) return alert("Enter Customer Name");
            if (!projectname) return alert("Enter Project Name");
            if (parchaseqty <= 0) return alert("Enter Quantity");

            // Prepare JSON with sequence arrays
            const newProject = {
                jobno: newjobno,
                project_type: autoAddWithSequence(null, "project_type", "NEW"),
                enquery_date: autoAddWithSequence(null, "enquery_date", new Date().toISOString().slice(0, 10)),
                project_name: projectname,
                customer: customername,
                contact_person: contactperson,
                quantity: autoAddWithSequence(null, "quantity", Number(parchaseqty) || 0 ),
                expected_date: autoAddWithSequence(null, "expected_date", todate),
                overallstatus: "ALLOCATE"
            };

            console.log("Sending project:", newProject);

            // POST to backend API
            fetch(`/projects`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newProject)
            })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to create project");
                    return res.json();
                })
                .then(data => {
                    alert("Project Created Successfully");
                    closeup();   // your UI close function
                    loadAPI();   // reload project list
                })
                .catch(err => {
                    console.error("Create project failed:", err);
                    alert("Project creation failed. Check console for details.");
                });
        }


        
        function allocatepage() {
            localStorage.setItem("selectedDesigner", "Allocate");
            window.location.href = "login"
        }

        function draftingpage() {
            localStorage.setItem("selectedDesigner", "Drafting");
            window.location.href = "login"
        }

        function closetype() {
            document.getElementById("reworkjobnoList").classList.add("hidden");
            document.getElementById("jobreworkBtn").classList.add("hidden");
            document.getElementById("projecttype").classList.add("hidden");
            document.getElementById("userDropdown").classList.add("hidden");
            document.getElementById("showrework").classList.add("hidden");
            document.getElementById("vmcDropdown").classList.add("hidden");
            if (currentprocess) {
                processBtn.classList.remove("bg-green-500");
                currentprocess = null;
            }
            document.getElementById("useraccess").classList.add("hidden");
        }

        function closeup() {
            document.getElementById("project").classList.add("hidden");
            document.getElementById("status").classList.add("hidden");
        }

        function closecus() {
            document.getElementById("project").classList.remove("hidden");
        }

        let selectitem = null;
        function loadAPI() {
            fetch(`/projects`)
                .then(res => res.json())
                .then(data => {

                    const liveproject = document.getElementById("liveproject");
                    const setprioritystatus = document.getElementById("setprioritystatus");
                    const setlinestatus = document.getElementById("setlinestatus");

                    if (liveproject) liveproject.innerHTML = "";
                    if (setprioritystatus) setprioritystatus.innerHTML = "";
                    if (setlinestatus) setlinestatus.innerHTML = "";

                    // filter items
                    const liveItems = data.filter(item =>
                        ["LIVE", "PRIORITY"].includes((item.overallstatus ?? "").toUpperCase())
                    );

                    const priorityItems = data.filter(item =>
                        (item.overallstatus ?? "").toUpperCase() === "PRIORITY"
                    );

                    const lineItems = data.filter(item =>
                        (item.overallstatus ?? "").toUpperCase() === "LIVE"
                    );

                    // ----------------------------
                    // LIVE PROJECTS
                    // ----------------------------
                    if (liveproject) {

                        if (liveItems.length === 0) {
                            liveproject.innerHTML = `<div class="text-sm font-bold text-red-500">NO LIVE JOBS</div>`;
                        } else {
                            liveItems
                                .sort((a, b) => new Date(a.expected_date) - new Date(b.expected_date))
                                .forEach(item => {

                                    const lastQty = Array.isArray(item.quantity) && item.quantity.length > 0
                                        ? Object.values(item.quantity[item.quantity.length - 1])[0]
                                        : "-";

                                    const lastDate = Array.isArray(item.expected_date) && item.expected_date.length > 0
                                        ? Object.values(item.expected_date[item.expected_date.length - 1])[0]
                                        : "-";

                                    liveproject.innerHTML += `
                                            <div class="mt-2 bg-white p-5 rounded-2xl shadow hover:shadow-xl md:w-[500px]" data-id="${item.id}">
                                                <h2 class="text-xl text-center font-bold text-gray-800 mb-2">${item.project_name}</h2>

                                                <div class="flex justify-between">
                                                    <p class="text-gray-700"><b>Job No:</b> ${item.jobno}</p>
                                                    <div>
                                                        <p class="text-gray-700"><b>Customer:</b> ${item.customer}</p>
                                                        <p class="text-gray-700"><b>Contact:</b> ${item.contact_person}</p>
                                                    </div>
                                                </div>

                                                <div class="flex justify-between mt-3">
                                                    <p class="text-gray-700">Quantity: <b class="text-2xl gap-2">${lastQty} set</b></p>
                                                    <button onclick="overallstatus(${item.id},'${item.jobno}')" class="rounded-2xl bg-gray-300 p-2.5 px-5 shadow">
                                                        <strong>Expected: ${lastDate ? new Date(lastDate).toLocaleDateString() : '—'}</strong>
                                                    </button>
                                                </div>
                                            </div>`;
                                });
                        }
                    }

                    // ----------------------------
                    // PRIORITY PROJECTS
                    // ----------------------------
                    if (setprioritystatus) {

                        if (priorityItems.length === 0) {
                            setprioritystatus.innerHTML = `<div class="text-sm font-bold text-red-500"></div>`;
                        } else {
                            priorityItems
                                .sort((a, b) => new Date(a.expected_date) - new Date(b.expected_date))
                                .forEach((item, index) => {
                                    const lastQty = Array.isArray(item.quantity) && item.quantity.length > 0
                                        ? Object.values(item.quantity[item.quantity.length - 1])[0]
                                        : "-";

                                    setprioritystatus.innerHTML += `
                                        <div class="rounded-2xl p-2 bg-blue-100 mt-1 hover:shadow-xl">
                                            <div class="text-center item-center">
                                            <div class="text-2xl font-semibold mb-1">${item.jobno} - ${lastQty}  set</div>
                                            <div class="text-sm text-slate-500 mb-2">${item.project_name}</div>
                                        </div>
                                        <div class="flex gap-2 text-center">
                                            <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">PRODUCTON</div>
                                            <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">Assembly</div>
                                            <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">Delivery</div>
                                        </div>
                                    </div>`;
                                });
                        }
                    }

                    // ----------------------------
                    // LINE PROJECTS
                    // ----------------------------
                    if (setlinestatus) {

                        if (lineItems.length === 0) {
                            setlinestatus.innerHTML = `<div class="text-sm font-bold text-red-500"></div>`;
                        } else {
                            lineItems
                                .sort((a, b) => new Date(a.expected_date) - new Date(b.expected_date))
                                .forEach((item, index) => {
                                    const lastQty = Array.isArray(item.quantity) && item.quantity.length > 0
                                        ? Object.values(item.quantity[item.quantity.length - 1])[0]
                                        : "-";

                                setlinestatus.innerHTML += `
                                        <div class="rounded-2xl p-2 bg-blue-100 mt-1 hover:shadow-xl">
                                            <div class="text-center item-center">
                                                <div class="text-2xl font-semibold mb-1">${item.jobno} - ${lastQty}  set</div>
                                                <div class="text-sm text-slate-500 mb-2">${item.project_name}</div>
                                            </div>
                                            <div class="flex gap-2 text-center">
                                                <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">PRODUCTON</div>
                                                <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">Assembly</div>
                                                <div class="rounded-2xl bg-white border p-4 w-1/3 shadow">Delivery</div>
                                            </div>
                                        </div>`;
                            });
                        }
                    }
                })
                .catch(err => {
                    const liveproject = document.getElementById("liveproject");
                    if (liveproject) liveproject.innerHTML = `<p class="text-red-500 font-semibold">Error: ${err}</p>`;
                    console.error(err);
                });
        }


        

        //status of designers projects
        async function showdesigners() {
            try {
                const projRes = await fetch(`/projects`);
                const projects = await projRes.json();

                const liveRes = await fetch(`/live_projects`);
                const liveProjects = await liveRes.json();

                const container = document.getElementById("designersprojects");
                if (!container) return;
                container.innerHTML = "";

                // 🔹 LIVE JOBNO SET
                const liveJobSet = new Set(
                    liveProjects.map(l => (l.jobno ?? "").toUpperCase())
                );

                // 🔹 FILTER ONLY LIVE PROJECTS
                const liveOnlyProjects = projects.filter(p =>
                    liveJobSet.has((p.jobno ?? "").toUpperCase())
                );

                // 🔹 GROUP BY DESIGNER
                const designerMap = {};
                liveOnlyProjects.forEach(p => {
                    const designer =
                        Array.isArray(p.designer_name) && p.designer_name.length > 0
                            ? Object.values(p.designer_name[p.designer_name.length - 1])[0]
                            : "UNASSIGNED";

                    if (!designerMap[designer]) designerMap[designer] = [];
                    designerMap[designer].push(p);
                });

                // 🔹 RENDER DESIGNER COLUMNS
                Object.entries(designerMap).forEach(([designer, myProjects]) => {

                    // SORT BY LAST EXPECTED DATE
                    myProjects.sort((a, b) => {
                        const da = a.expected_date?.length
                            ? new Date(Object.values(a.expected_date.at(-1))[0])
                            : new Date(0);
                        const db = b.expected_date?.length
                            ? new Date(Object.values(b.expected_date.at(-1))[0])
                            : new Date(0);
                        return da - db;
                    });

                    let columnHTML = `
            <div class="bg-gray-50 p-1 rounded-xl shadow">
                <h2 class="text-xl font-bold text-blue-700 text-center">${designer}</h2>
                <div class="md:h-[39vh] overflow-auto thin-scrollbar mt-1 px-4">
            `;

                    myProjects.forEach(item => {
                        let stage = "Not Started";
                        if (Array.isArray(item.design_stages) && item.design_stages.length > 0) {
                            const lastObj = item.design_stages.at(-1);
                            stage = Object.values(lastObj)[0] || stage;
                        }

                        const lastQty = item.quantity?.length
                            ? Object.values(item.quantity.at(-1))[0]
                            : "-";

                        const lastDate = item.expected_date?.length
                            ? Object.values(item.expected_date.at(-1))[0]
                            : "-";

                        columnHTML += `
                <div class="bg-white p-4 rounded-xl mb-4 shadow border hover:shadow-lg transition">
                    <p class="font-semibold">${item.jobno} - ${item.project_name}</p>
                    <p class="text-sm text-gray-700">
                        Customer: ${item.customer} - ${item.contact_person}
                    </p>

                    <div class="flex justify-between mt-2">
                        <p><b>Qty:</b> ${lastQty}</p>
                        <p><b>Expected:</b> ${lastDate}</p>
                    </div>

                    <p class="mt-2">
                        <b>Status:</b>
                        <span class="text-green-600 font-bold">${stage}</span>
                    </p>
                </div>`;
                    });

                    columnHTML += `</div></div>`;
                    container.innerHTML += columnHTML;
                });

            } catch (err) {
                console.error(err);
                document.getElementById("designersprojects").innerHTML =
                    `<p class="text-red-500 font-semibold">Error loading data</p>`;
            }
        }

        function formatByDnType(text, dnType) {
            const val = text || "";
            const type = String(dnType || "NEW").toUpperCase();

            if (type === "OLD") {
                return `<span class="line-through text-gray-400">${val}</span>`;
            }
            return `<span class="text-black">${val}</span>`;
        }

        function formatProcessByDnType(html, dnType) {
            const type = String(dnType || "NEW").toUpperCase();

            if (type === "OLD") {
                return `<div class="line-through text-gray-400 opacity-60">${html}</div>`;
            }
            return html;
        }
        
        // -----------------------------------------------------------
        // STATUS BADGES
        // -----------------------------------------------------------
        function statusBadge(status) {
            if (!status || status === "Not Started")
                return `<span></span>`;
            if (status === "Pending")
                return `<span class="px-2 py-0.5 rounded bg-yellow-200 text-yellow-900 text-xs font-semibold">Pending</span>`;
            if (status === "Completed")
                return `<span class="px-2 py-0.5 rounded bg-green-200 text-green-900 text-xs font-semibold">Completed</span>`;
            if (status === "Hold")
                return `<span class="px-2 py-0.5 rounded bg-red-200 text-red-900 text-xs font-semibold">Hold</span>`;
            return `<span class="px-2 py-0.5 rounded bg-gray-200 text-gray-700 text-xs">${status}</span>`;
        }

        // -----------------------------------------------------------
        // 🔥 MAIN FUNCTION — LOAD LIVE PROJECTS
        // -----------------------------------------------------------
        async function loadLiveProjects() {
            try {
                const [resLive, resProjects] = await Promise.all([
                    fetch(`/live_projects`),
                    fetch(`/projects`)
                ]);
                if (!resLive.ok || !resProjects.ok) throw new Error("API fetch failed");
                const liveDataRaw = await resLive.json();
                const projectsData = await resProjects.json();
                // Filter only LIVE
                const liveProjects = projectsData.filter(p => (p.overallstatus === "LIVE") || (p.overallstatus === "PRIORITY"));
                // Map jobno → live project object
                const liveMap = Object.fromEntries(liveDataRaw.map(p => [p.jobno, p]));
                loadProcessButtons(liveMap);
                const liveData = liveProjects
                    .map(p => liveMap[p.jobno])
                    .filter(Boolean);
                
                const container = document.getElementById("tableContainer");
                container.innerHTML = "";
                // -----------------------------------------------------------
                // Render per project
                // -----------------------------------------------------------
                liveData.forEach(project => {
                    const projInfo = projectsData.find(j => j.jobno === project.jobno) || {};
                    // 👉 GET SHORT ORDER PROCESS LIST (PROGRAM, VMC, DRO, TURNING, ANODYZING…)
                    const projectProcesses = getProjectProcesses(project);
                    const block = document.createElement("div");
                    block.className = "bg-white shadow-xl rounded-xl p-6 mb-8";
                    // -----------------------------------------------------------
                    // HEADER
                    // -----------------------------------------------------------
                    const designer_name = Array.isArray(projInfo.designer_name) && projInfo.designer_name.length > 0
                        ? Object.values(projInfo.designer_name[projInfo.designer_name.length - 1])[0]
                        : "-";

                    const drafting = Array.isArray(projInfo.drafting) && projInfo.drafting.length > 0
                        ? Object.values(projInfo.drafting[projInfo.drafting.length - 1])[0]
                        : "-";

                    block.innerHTML = `
                    <div class="text-center mb-4">
                    <div class="text-xl font-semibold text-indigo-700">
                    <p class="font-bold text-xl text-green-600">${project.jobno}</p><p class="font-semibold text-m text-indigo-600">${projInfo.project_name || "N/A"}</p>
                    </div>
                    <div class="flex justify-between text-gray-700 text-sm mt-2">
                    <div><b>Designer:</b> ${designer_name || "Not Assigned"}</div>
                    <div><b>Drafting:</b> ${drafting || "Not Assigned"}</div>
                    </div>
                    </div>`;
                    // -----------------------------------------------------------
                    // TABLE HEADER
                    // -----------------------------------------------------------
                    let html = `
                    <div class="overflow-auto">
                    <table class="w-full border-collapse">
                    <thead>
                    <tr class="bg-indigo-50 text-indigo-900 font-semibold text-sm">
                    <th class="border p-2">D.No</th>
                    <th class="border p-2">Description</th>
                    <th class="border p-2">Qty</th>
                    ${projectProcesses.map(p => `<th class="border p-2">${p}</th>`).join("")} 
                    </tr>
                    </thead>
                    <tbody>`;

                    // -----------------------------------------------------------
                    // DNO ROWS
                    // -----------------------------------------------------------
                    

                    for (let d = 1; d <= 50; d++) {
                        const list = project[`dno_${d}`];
                        if (!Array.isArray(list)) continue;
                        list.forEach(row => {
                            // Build status map
                            const statusMap = {};
                            if (Array.isArray(row.InternalProcess)) {
                                row.InternalProcess.forEach(p =>
                                    statusMap[p.name.toUpperCase()] = p.status
                                );
                            }
                            const processCols = projectProcesses
                                .map(proc => {
                                    const st = statusMap[proc] || "Not Started";
                                    const badge = statusBadge(st);

                                    return `
                                        <td class="border p-2 text-center">${formatProcessByDnType(badge, row.dn_type)}</td>`;
                                })
                                .join("");
                            html += `
                            <tr class="border-b hover:bg-gray-50 text-sm">
                            <td class="border p-2">${formatByDnType(row.Sl_No, row.dn_type)}</td>
                            <td class="border p-2">${formatByDnType(row.Description, row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatByDnType(row.TotalQty, row.dn_type)}</td>
                            ${processCols}
                            </tr>`;
                        });
                    }
                    html += `
                    </tbody>
                    </table>
                    </div>`;
                    block.innerHTML += html;

                    // STATIC SECTION
                    const clist = Array.isArray(project.common_status)
                        ? project.common_status
                        : [];

                    // Defaults
                    let assembly = null;
                    let delivery = null;

                    // Find statuses
                    clist.forEach(cp => {
                        const name = String(cp.name).trim().toUpperCase();
                        if (name === "ASSEMBLY") assembly = cp;
                        if (name === "DELIVERY") delivery = cp;
                    });

                    // Render COMMON STATUS section
                    block.innerHTML += `
                    <div class="flex justify-between p-1 mt-3">
                        <div class="flex gap-2 items-center">
                        <div class="font-bold">ASSEMBLY:</div>
                        ${statusBadge(assembly?.status)}
                        </div>
                        <div class="flex gap-2 items-center">
                            <div class="font-bold">DELIVERY:</div>
                            ${statusBadge(delivery?.status)}
                        </div>
                    </div>`;

                    // ✅ append ONCE
                    container.appendChild(block);

                });

            } catch (err) {
                console.error("ERROR:", err);
                alert("Failed to load live projects: " + err.message);
            }
        }


        // ---------------------------------------------------------
        // PRODUCTION PROCESS STATUS
        // ---------------------------------------------------------
        async function loadProcessPage(processName, containerId) {
            try {
                const [resLive, resProjects] = await Promise.all([
                    fetch(`/live_projects`),
                    fetch(`/projects`)
                ]);

                if (!resLive.ok || !resProjects.ok)
                    throw new Error("API fetch failed");

                const liveDataRaw = await resLive.json();
                const projectsData = await resProjects.json();

                const liveProjects = projectsData.filter(
                    p => p.overallstatus === "LIVE" || p.overallstatus === "PRIORITY"
                );

                const liveMap = Object.fromEntries(
                    liveDataRaw.map(p => [p.jobno, p])
                );

                const liveData = liveProjects
                    .map(p => liveMap[p.jobno])
                    .filter(Boolean);

                const container = document.getElementById(containerId);
                container.innerHTML = "";

                liveData.forEach(project => {
                    const projInfo = projectsData.find(j => j.jobno === project.jobno) || {};
                    let rowsToShow = [];

                    for (let d = 1; d <= 50; d++) {
                        const list = project[`dno_${d}`];
                        if (!Array.isArray(list)) continue;

                        list.forEach(row => {
                            let program = null;
                            let vmc = null;
                            let normal = null;

                            row.InternalProcess?.forEach(p => {
                                const pname = p.name.trim().toUpperCase();

                                if (processName === "VMC") {
                                    if (pname === "PROGRAM") program = p;
                                    if (pname === "VMC") vmc = p;
                                } else if (pname === processName.toUpperCase()) {
                                    normal = p;
                                }
                            });

                            if (
                                (processName === "VMC" && (program || vmc)) ||
                                (processName !== "VMC" && normal)
                            ) {
                                rowsToShow.push({
                                    ...row,
                                    program,
                                    vmc,
                                    normal
                                });
                            }
                        });
                    }

                    if (rowsToShow.length === 0) return;

                    const block = document.createElement("div");
                    block.className = "bg-white shadow-xl rounded-xl p-6 mb-8";

                    const designer_name = Array.isArray(projInfo.designer_name) && projInfo.designer_name.length > 0
                        ? Object.values(projInfo.designer_name[projInfo.designer_name.length - 1])[0]
                        : "-";

                    const drafting = Array.isArray(projInfo.drafting) && projInfo.drafting.length > 0
                        ? Object.values(projInfo.drafting[projInfo.drafting.length - 1])[0]
                        : "-";

                    block.innerHTML = `
                        <div class="text-center mb-4">
                            <p class="text-xl font-bold text-green-600">${project.jobno} - ${processName}</p>
                            <p class="font-semibold text-indigo-600">${projInfo.project_name || "N/A"}</p>
                            <div class="flex justify-between text-gray-700 text-sm mt-2">
                            <div><b>Designer:</b> ${designer_name || "Not Assigned"}</div>
                            <div><b>Drafting:</b> ${drafting || "Not Assigned"}</div>
                        </div>
                        </div>`;

                    // ---------------- TABLE HEADER ----------------
                    let table = `
                    <div class="overflow-auto">
                    <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-indigo-50 text-indigo-900 text-sm font-semibold">
                        <th class="border p-2">D.No</th>
                        <th class="border p-2">Description</th>
                        <th class="border p-2">Qty</th>`;

                    if (processName === "VMC") {
                        table += `
                        <th class="border p-2">PROGRAM</th>
                        <th class="border p-2">VMC</th>
                        <th class="border p-2">Start</th>
                        <th class="border p-2">End</th>
                        <th class="border p-2">OPT</th>`;
                    } else {
                        table += `
                        <th class="border p-2">Status</th>
                        <th class="border p-2">Start</th>
                        <th class="border p-2">End</th>
                        <th class="border p-2">OPT</th>`;
                    }
                    table += `</tr></thead><tbody>`;

                    // ---------------- TABLE ROWS ----------------
                    rowsToShow.forEach(row => {
                        table += `
                        <tr class="border-b hover:bg-gray-50 text-sm">
                        <td class="border p-2">${formatByDnType(row.Sl_No, row.dn_type)}</td>
                        <td class="border p-2">${formatByDnType(row.Description, row.dn_type)}</td>
                        <td class="border p-2 text-center">${formatByDnType(row.TotalQty, row.dn_type)}</td>`;

                        if (processName === "VMC") {
                            table += `
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.program?.status || "Not Started") + statusBadge(row.program?.operator || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.vmc?.status || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.vmc?.sdate || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.vmc?.edate || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.vmc?.operator || "Not Started"), row.dn_type)}</td>`;
                        } else {
                            table += `
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.normal?.status || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.normal?.sdate || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.normal?.edate || "Not Started"), row.dn_type)}</td>
                            <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.normal?.operator || "Not Started"), row.dn_type)}</td>`;
                        }

                        table += `</tr>`;
                    });

                    table += `</tbody></table></div>`;
                    block.innerHTML += table;

                    container.appendChild(block);
                });

            } catch (err) {
                console.error(err);
                alert("Failed to load " + processName);
            }
        }

        // -----------------------------------------------------------
        // 🔥 MAIN FUNCTION — LOAD FINISH PROJECTS
        // -----------------------------------------------------------
        function renderProcessTable(processName, liveData, projectsData, container) {

            liveData.forEach(project => {
                const projInfo = projectsData.find(j => j.jobno === project.jobno) || {};
                let rowsToShow = [];

                for (let d = 1; d <= 50; d++) {
                    const list = project[`dno_${d}`];
                    if (!Array.isArray(list)) continue;

                    list.forEach(row => {
                        let match = null;

                        const btn = document.getElementById("finprocessButtons");

                        row.InternalProcess?.forEach(p => {
                            if (p.name?.trim().toUpperCase() === processName) {
                                match = p;
                                btn?.classList.remove("hidden");
                            }
                        });

                        if (match) {
                            rowsToShow.push({ ...row, proc: match });
                        }
                    });
                }

                if (rowsToShow.length === 0) return;


                const block = document.createElement("div");
                block.className = "bg-white shadow-xl rounded-xl p-6 mb-10";

                const designer_name = Array.isArray(projInfo.designer_name) && projInfo.designer_name.length > 0
                    ? Object.values(projInfo.designer_name[projInfo.designer_name.length - 1])[0]
                    : "-";

                const drafting = Array.isArray(projInfo.drafting) && projInfo.drafting.length > 0
                    ? Object.values(projInfo.drafting[projInfo.drafting.length - 1])[0]
                    : "-";

                block.innerHTML = `
                    <div class="text-center mb-4">
                        <p class="text-xl font-bold text-green-600">${project.jobno} – ${processName}</p>
                        <p class="font-semibold text-indigo-600">${projInfo.project_name || "N/A"}</p>
                        <div class="flex justify-between text-gray-700 text-sm mt-2">
                        <div><b>Designer:</b> ${designer_name || "Not Assigned"}</div>
                        <div><b>Drafting:</b> ${drafting || "Not Assigned"}</div>
                    </div>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-indigo-50 text-indigo-900 text-sm font-semibold">
                                <th class="border p-2">D.No</th>
                                <th class="border p-2">Description</th>
                                <th class="border p-2">Qty</th>
                                <th class="border p-2">Status</th>
                                <th class="border p-2">Start</th>
                                <th class="border p-2">End</th>
                                <th class="border p-2">OPT</th>
                            </tr>
                        </thead>
                        <tbody>${rowsToShow.map(row => `
                            <tr class="border-b hover:bg-gray-50 text-sm">
                                <td class="border p-2">${formatByDnType(row.Sl_No, row.dn_type)}</td>
                                <td class="border p-2">${formatByDnType(row.Description, row.dn_type)}</td>
                                <td class="border p-2 text-center">${formatByDnType(row.TotalQty, row.dn_type)}</td>
                                <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.proc.status || "Not Started"), row.dn_type)}</td>
                                <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.proc.sdate || "Not Started"), row.dn_type)}</td>
                                <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.proc.edate || "Not Started"), row.dn_type)}</td>
                                <td class="border p-2 text-center">${formatProcessByDnType(statusBadge(row.proc.operator || "Not Started"), row.dn_type)}</td>
                            </tr>`).join("")}
                        </tbody>
                    </table>
                    </div>`;
                container.appendChild(block);
            });
        }


        async function loadFinishProjects() {
            try {

                const [resLive, resProjects] = await Promise.all([
                    fetch(`/live_projects`),
                    fetch(`/projects`)
                ]);

                if (!resLive.ok || !resProjects.ok)
                    throw new Error("API fetch failed");

                const liveDataRaw = await resLive.json();
                const projectsData = await resProjects.json();

                const liveProjects = projectsData.filter(
                    p => p.overallstatus === "LIVE" || p.overallstatus === "PRIORITY"
                );

                const liveMap = Object.fromEntries(
                    liveDataRaw.map(p => [p.jobno, p])
                );
                loadfinProcessButtons(liveMap);

                const liveData = liveProjects
                    .map(p => liveMap[p.jobno])
                    .filter(Boolean);

                const container = document.getElementById("finishContainer");
                container.innerHTML = "";

                // 🔥 ONE PAGE – LOOP ALL FINISH PROCESSES
                FINISH_ORDER.forEach(processName => {
                    renderProcessTable(processName, liveData, projectsData, container);
                });

            } catch (err) {
                console.error(err);
                alert("Failed to load FINISH processes");
            }
        }

        function renderassemblyTable(statusName, liveData, projectsData, container) {

            const TARGET = statusName.trim().toUpperCase();

            // clear container
            container.innerHTML = "";

            // create wrapper + table once
            const wrapper = document.createElement("div");
            wrapper.className = "overflow-auto bg-white shadow-xl rounded-xl p-6";

            wrapper.innerHTML = `
                <div class="text-center mb-4">
    <p class="text-xl font-bold text-green-600">
        ${TARGET}
    </p>
</div>
<table class="w-full border-collapse">
<thead>
<tr class="bg-indigo-50 text-indigo-900 text-sm font-semibold">
    <th class="border p-2">JOB No.</th>
    <th class="border p-2">Description</th>
    <th class="border p-2">Designer</th>
    <th class="border p-2">Drafting</th>
    <th class="border p-2">Quantity</th>
    <th class="border p-2">Status</th>
    <th class="border p-2">Start</th>
    <th class="border p-2">End</th>
</tr>
</thead>
<tbody id="assemblyTableBody"></tbody>
</table>
`;

            container.appendChild(wrapper);

            const tbody = wrapper.querySelector("#assemblyTableBody");

            // loop all live projects
            liveData.forEach(project => {

                const projInfo = projectsData.find(j => j.jobno === project.jobno) || {};

                const clist = Array.isArray(project.common_status)
                    ? project.common_status
                    : [];

                const match = clist.find(cs =>
                    cs.name?.trim().toUpperCase() === TARGET
                );

                if (!match) return;

                const row = document.createElement("tr");
                row.className = "border-b hover:bg-gray-50 text-sm text-center";

                const designer_name = Array.isArray(projInfo.designer_name) && projInfo.designer_name.length > 0
                    ? Object.values(projInfo.designer_name[projInfo.designer_name.length - 1])[0]
                    : "-";

                const drafting = Array.isArray(projInfo.drafting) && projInfo.drafting.length > 0
                    ? Object.values(projInfo.drafting[projInfo.drafting.length - 1])[0]
                    : "-";

                const quantity = Array.isArray(projInfo.quantity) && projInfo.quantity.length > 0
                    ? Object.values(projInfo.quantity[projInfo.quantity.length - 1])[0]
                    : "-";

                row.innerHTML = `
<td class="border p-2">${project.jobno}</td>
<td class="border p-2">${projInfo.project_name || "N/A"}</td>
<td class="border p-2">${designer_name || "Not Assigned"}</td>
<td class="border p-2">${drafting || "Not Assigned"}</td>
<td class="border p-2">${quantity || "N/A"}</td>
<td class="border p-2">${statusBadge(match.status)}</td>
<td class="border p-2">${statusBadge(match.sdate) || "-"}</td>
<td class="border p-2">${statusBadge(match.edate) || "-"}</td>
`;

                tbody.appendChild(row);
            });
        }



        async function loadassemblyProjects() {
            try {
                const [resLive, resProjects] = await Promise.all([
                    fetch(`/live_projects`),
                    fetch(`/projects`)
                ]);

                if (!resLive.ok || !resProjects.ok)
                    throw new Error("API fetch failed");

                const liveDataRaw = await resLive.json();
                const projectsData = await resProjects.json();

                const liveProjects = projectsData.filter(
                    p => p.overallstatus === "LIVE" || p.overallstatus === "PRIORITY"
                );

                const liveMap = Object.fromEntries(
                    liveDataRaw.map(p => [p.jobno, p])
                );

                const liveData = liveProjects
                    .map(p => liveMap[p.jobno])
                    .filter(Boolean);

                const container = document.getElementById("assemblyContainer");
                container.innerHTML = "";

                // 🔥 ONLY COMMON STATUS
                const COMMON_ORDER = ["ASSEMBLY"];

                COMMON_ORDER.forEach(statusName => {
                    renderassemblyTable(statusName, liveData, projectsData, container);
                });

            } catch (err) {
                console.error(err);
                alert("Failed to load Assembly");
            }
        }


        function renderdeliveryTable(statusName, liveData, projectsData, container) {

            const TARGET = statusName.trim().toUpperCase();

            // clear container
            container.innerHTML = "";

            // create table once
            const tableWrapper = document.createElement("div");
            tableWrapper.className = "overflow-auto bg-white shadow-xl rounded-xl p-6";

            tableWrapper.innerHTML = `

    <div class="text-center mb-4">
    <p class="text-xl font-bold text-green-600">
        ${TARGET}
    </p>
</div>
<table class="w-full border-collapse">
<thead>
<tr class="bg-indigo-50 text-indigo-900 text-sm font-semibold">
    <th class="border p-2">JOB No.</th>
    <th class="border p-2">Description</th>
    <th class="border p-2">Designer</th>
    <th class="border p-2">Qty</th>
    <th class="border p-2">PO</th>
    <th class="border p-2">Delivery Status</th>
    <th class="border p-2">Start</th>
    <th class="border p-2">End</th>
    <th class="border p-2">Response</th>
</tr>
</thead>
<tbody id="deliveryTableBody"></tbody>
</table>
`;

            container.appendChild(tableWrapper);

            const tbody = tableWrapper.querySelector("#deliveryTableBody");

            // loop projects
            liveData.forEach(project => {

                const projInfo = projectsData.find(j => j.jobno === project.jobno) || {};

                const clist = Array.isArray(project.common_status)
                    ? project.common_status
                    : [];

                const match = clist.find(cs =>
                    cs.name?.trim().toUpperCase() === TARGET
                );

                if (!match) return;

                const row = document.createElement("tr");
                row.className = "border-b hover:bg-gray-50 text-sm text-center";

                const designer_name = Array.isArray(projInfo.designer_name) && projInfo.designer_name.length > 0
                    ? Object.values(projInfo.designer_name[projInfo.designer_name.length - 1])[0]
                    : "-";

                const drafting = Array.isArray(projInfo.drafting) && projInfo.drafting.length > 0
                    ? Object.values(projInfo.drafting[projInfo.drafting.length - 1])[0]
                    : "-";

                const quantity = Array.isArray(projInfo.quantity) && projInfo.quantity.length > 0
                    ? Object.values(projInfo.quantity[projInfo.quantity.length - 1])[0]
                    : "-";

                row.innerHTML = `
<td class="border p-2">${project.jobno}</td>
<td class="border p-2">${projInfo.project_name || "N/A"}</td>
<td class="border p-2">${designer_name || "Not Assigned"}</td>
<td class="border p-2">${quantity}</td>
<td class="border p-2">${statusBadge(match.po) || "-"}</td>
<td class="border p-2">${statusBadge(match.status)}</td>
<td class="border p-2">${statusBadge(match.sdate) || "-"}</td>
<td class="border p-2">${statusBadge(match.edate) || "-"}</td>
<td class="border p-2">${statusBadge(match.operator) || "-"}</td>
`;

                tbody.appendChild(row);
            });
        }


        async function loaddeliveryProjects() {
            try {
                const [resLive, resProjects] = await Promise.all([
                    fetch(`/live_projects`),
                    fetch(`/projects`)
                ]);

                if (!resLive.ok || !resProjects.ok)
                    throw new Error("API fetch failed");

                const liveDataRaw = await resLive.json();
                const projectsData = await resProjects.json();

                const liveProjects = projectsData.filter(
                    p => p.overallstatus === "LIVE" || p.overallstatus === "PRIORITY"
                );

                const liveMap = Object.fromEntries(
                    liveDataRaw.map(p => [p.jobno, p])
                );

                const liveData = liveProjects
                    .map(p => liveMap[p.jobno])
                    .filter(Boolean);

                const container = document.getElementById("deliveryContainer");
                container.innerHTML = "";

                // 🔥 ONLY COMMON STATUS
                const COMMON_ORDER = ["DELIVERY"];

                COMMON_ORDER.forEach(statusName => {
                    renderdeliveryTable(statusName, liveData, projectsData, container);
                });

            } catch (err) {
                console.error(err);
                alert("Failed to load Delivery");
            }
        }

        // -----------------------------------------------------------
        // Helper: Collect all process names from all dno_x entries
        // -----------------------------------------------------------
        function getProjectProcesses(project) {
            const found = new Set();

            for (let i = 1; i <= 50; i++) {
                const rows = project[`dno_${i}`];
                if (!Array.isArray(rows)) continue;

                rows.forEach(r => {
                    r.InternalProcess?.forEach(p => {
                        found.add(p.name.trim().toUpperCase());
                    });
                });
            }

            // ✅ keep SQL process order, show only used ones
            return FIXED_ORDER.filter(p => found.has(p));
        }


        function normalize(name) {
            return name.trim().toUpperCase();
        }

        // -----------------------------------------------------------
        // Helper: Collect unique process names from all dno_x entries
        // -----------------------------------------------------------
        function getfinProjectProcesses(project) {
            const found = new Set();

            for (let i = 1; i <= 50; i++) {
                const rows = project[`dno_${i}`];
                if (!Array.isArray(rows)) continue;

                rows.forEach(r => {
                    r.InternalProcess?.forEach(p => {
                        found.add(p.name.trim().toUpperCase());
                    });
                });
            }

            // ✅ keep SQL process order, show only used ones
            return FINISH_ORDER.filter(p => found.has(p));
        }

        // --------------------------------------------
        // PROCESS ORDER for fixced, production, finish
        // --------------------------------------------
        let FIXED_ORDER = [];
        let PRODUCTION_ORDER = [];
        let FINISH_ORDER = [];

        function normalizeId(name) {
            return name.trim().toLowerCase().replace(/\s+/g, "_");
        }

        async function buildProcessSections() {
            const res = await fetch("/processes");
            const processes = await res.json();

            const wrapper = document.getElementById("processWrapper");
            wrapper.innerHTML = "";

            processes.forEach(p => {
                const pid = normalizeId(p.process_name);

                PRODUCTION_ORDER = processes
                    .filter(p => p.process_type === "PRODUCTION")
                    .map(p => p.process_name);

                FINISH_ORDER = processes
                    .filter(p => p.process_type === "FINISH")
                    .map(p => p.process_name);

                FIXED_ORDER = processes
                    .map(p => p.process_name);

                wrapper.innerHTML += `
        <div id="${pid}" class="fixed lg:pl-[190px] processSection hidden h-[90vh] overflow-y-scroll thin-scrollbar w-full">
            <div id="${pid}Container"
                 class="px-2 py-2 grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-4 mt-2">
            </div>
        </div>`;
            });
        }

        function loadProcessButtons(liveMap) {
            const sidebar = document.getElementById("processButtons");
            sidebar.innerHTML = "";

            const found = new Set();

            // Collect used processes from live projects
            Object.values(liveMap).forEach(project => {
                for (let d = 1; d <= 50; d++) {
                    const list = project[`dno_${d}`];
                    if (!Array.isArray(list)) continue;

                    list.forEach(row => {
                        row.InternalProcess?.forEach(p => {
                            found.add(normalize(p.name));
                        });
                    });
                }
            });

            // ✅ FILTER DB ORDER (NO RENAMING)
            const ordered = PRODUCTION_ORDER.filter(dbName =>
                found.has(normalize(dbName))
            );

            // Render buttons
            ordered
                .forEach(name => {
                sidebar.innerHTML += `
                    <div class="flex gap-2 justify-between">
                    <button
                    onclick="updatestatus('${name}', this)"
                    class="colourbtn btn flex text-left px-7 py-2 rounded-lg w-full">
                    ${name}
                    </button>
                    <button
                    onclick="operatorpage('${name}', this)"
                    class="absolute left-4 mt-2 h-6 hover:bg-green-500 rounded">
                    <span class="material-icons">arrow_drop_down</span>
                    </button>
                    </div>`;
                });
        }

        function loadfinProcessButtons(liveMap) {
            const sidebar = document.getElementById("finprocessButtons");
            sidebar.innerHTML = "";

            const found = new Set();

            // Collect used processes from live projects
            Object.values(liveMap).forEach(project => {
                for (let d = 1; d <= 50; d++) {
                    const list = project[`dno_${d}`];
                    if (!Array.isArray(list)) continue;

                    list.forEach(row => {
                        row.InternalProcess?.forEach(p => {
                            found.add(normalize(p.name));
                        });
                    });
                }
            });

            sidebar.innerHTML += `
            <div class="flex gap-2 justify-between">
            <button
            onclick="updatestatus('FINISH', this)"
            class="colourbtn btn flex text-left px-7 py-2 rounded-lg w-full">
            FINISH
            </button>
            <button
            onclick="operatorpage('FINISH', this)"
            class="absolute left-4 mt-2 h-6 hover:bg-green-500 rounded">
            <span class="material-icons">arrow_drop_down</span>
            </button>
            </div>`;
        }

        function loadassemblyProcessButtons() {
            const sidebar = document.getElementById("assemblyButtons");
            sidebar.innerHTML = "";

            sidebar.innerHTML = `
            <div class="flex gap-2 justify-between">
            <button 
            onclick="updatestatus('ASSEMBLY', this)"
            class="colourbtn btn flex text-left px-7 py-2 rounded-lg w-full">
            ASSEMBLY
            </button>
            <button
            onclick="operatorpage('ASSEMBLY', this)"
            class="absolute left-4 mt-2 h-6 hover:bg-green-500 rounded">
            <span class="material-icons">arrow_drop_down</span>
            </button>
            </div>`;
        }

        function loaddeliveryProcessButtons() {
            const sidebar = document.getElementById("deliveryButtons");
            sidebar.innerHTML = "";

            sidebar.innerHTML = `
            <div class="flex gap-2 justify-between">
            <button
            onclick="updatestatus('DELIVERY', this)"
            class="colourbtn btn flex text-left px-7 py-2 rounded-lg w-full">
            DELIVERY
            <button
            onclick="operatorpage('DELIVERY', this)"
            class="absolute left-4 mt-2 h-6 hover:bg-green-500 rounded">
            <span class="material-icons">arrow_drop_down</span>
            </button>
            </div>`;
        }

        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                const flag = localStorage.getItem("REFRESH_DASHBOARD");
                if (flag) {
                    localStorage.removeItem("REFRESH_DASHBOARD");
                    location.reload(); // 🔥 REFRESH ONLY
                }
            }
        });

        window.onload = () => {
            loadAPI();
            loaddesigners();
            showdesigners();
            loadLiveProjects();
            buildProcessSections();
            loadFinishProjects();
            loadassemblyProjects();
            loaddeliveryProjects();
            loaddeliveryProcessButtons();
            loadassemblyProcessButtons();
            let customers = [];
        };
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Simple scrollbar for tables */
        .thin-scrollbar::-webkit-scrollbar {
            height: 2px;
            width: 2px
        }

        .thin-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 8px
        }

        .thin-scrollbar::-webkit-scrollbar-track {
            background: transparent
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-900 h-screen overflow-hidden">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <header class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm">
        <div class="max-w-8xl mx-auto px-4 md:px-6 lg:px-8 flex justify-between">
            <div class="flex items-center justify-between h-12 md:h-20">
                <div class="flex items-center gap-4">
                    <button id="btnToggleSidebar" class="lg:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <span class="material-icons">menu</span>
                    </button>
                    <div class="flex-row lg:flex-row font-bold leading-tight items-end lg:gap-4">
                        <span class="md:text-5xl text-m font-bold text-green-500">AGTEK</span> <!-- Header AGTEK -->
                        <span class="md:text-2xl text-m text-sky-500 -mt-0.5">Project Monitoring Dashboard</span>
                    </div>
                </div>
            </div>
            <div class="md:mt-10 mt-2">
                <div class="items-center">
                    <button onclick="user_access()" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 text-black rounded-lg shadow">Setting</button>
                </div>
            </div>
        </div>
    </header>
    <!-- OVERLAY on mobile when sidebar open -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden lg:hidden"></div>
    <div class="pt-12 md:pt-20 h-[calc(104vh)] flex overflow-hidden">
        <aside id="sidebar"
               class="fixed h-[calc(104vh)] left-0 z-40 transform -translate-x-full lg:translate-x-0 lg:translate-y-0 transition-transform duration-300 w-[180px] md:w-[180px] bg-white border-r shadow-sm overflow-auto thin-scrollbar">
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <div class="text-lg font-semibold text-green-600">Navigation</div>
                    <button id="btnCloseSidebar" class="lg:hidden p-1 rounded hover:bg-gray-100">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <nav class="mt-4 space-y-1">
                    <button onclick="addproject()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 w-full">
                        <span class="material-icons text-sky-500">add_box</span>
                        <span>Add Project</span>
                    </button>
                    <button onclick="allocatepage()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 w-full">
                        <span class="material-icons text-green-500">assignment</span>
                        <span>Allocate</span>
                    </button>
                    <div class="relative z-40">
                        <button id="userMenuBtn" aria-haspopup="true" aria-expanded="false"
                                class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 w-full">
                            <span class="material-icons">person</span>
                            <span class="text-sm">Designing</span>
                            <span class="material-icons">arrow_drop_down</span>
                        </button>
                    </div>
                    <button onclick="draftingpage()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 w-full">
                        <span class="material-icons text-purple-500">edit_note</span>
                        <span>DRAFTING</span>
                    </button>
                </nav>

                <div class="mt-6">
                    <h3 class="text-xs text-slate-500 uppercase tracking-wide pl-2">Over All Status</h3>
                    <nav class="mt-2 space-y-2">

                        <!-- Static buttons -->
                        <button onclick="updatestatus('DESIGN',this)"
                                class="colourbtn btn flex px-3 py-1 rounded-lg w-full">
                            Design
                        </button>

                        <button onclick="updatestatus('DFM',this)"
                                class="colourbtn btn flex px-3 py-1 rounded-lg w-full">
                            DFM
                        </button>

                        <!-- Dynamic buttons (auto-created from API) -->
                        <div id="processButtons" class="mt-4 space-y-1"></div>

                        <!-- FINISING buttons (auto-created from API) -->
                        <div id="finprocessButtons" class="mt-4 space-y-1 hidden"></div>

                        <!-- ASSEMBLY buttons (auto-created from API) -->
                        <div id="assemblyButtons" class="mt-4 space-y-1"></div>

                        <!-- DELIVERY buttons (auto-created from API) -->
                        <div id="deliveryButtons" class="mt-4 space-y-1"></div>

                    </nav>
                </div>

            </div>
        </aside>
        <!-- Design and Production status -->
        <!-- design Project status -->
        <div id="design" class="fixed lg:pl-[190px] hidden w-full px-2 py-2">
            <div id="designersprojects" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[93vh] mt-2 overflow-auto thin-scrollbar"></div>
        </div>
        <!-- DFM Project status -->
        <div id="dfm" class="fixed lg:pl-[190px] hidden h-[94vh] overflow-y-scroll thin-scrollbar w-full">
            <div id="tableContainer" class="px-2 py-2 grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-4 mt-2"></div>
        </div>
        <!-- PRODUCTION status -->
        <div id="processWrapper"></div>
        <!-- FINISH status -->
        <div id="finish" class="fixed lg:pl-[190px] hidden h-[94vh] overflow-y-scroll thin-scrollbar w-full">
            <div id="finishContainer" class="px-2 py-2 grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-4 mt-2"></div>
        </div>
        <!-- ASSEMBLY status -->
        <div id="assembly" class="fixed lg:pl-[190px] hidden h-[94vh] overflow-y-scroll thin-scrollbar w-full">
            <div id="assemblyContainer" class="px-2 py-2 grid grid-cols-1 gap-4 mt-2"></div>
        </div>
        <!-- DELIVERY status -->
        <div id="delivery" class="fixed lg:pl-[190px] hidden h-[93vh] overflow-y-scroll thin-scrollbar w-full">
            <div id="deliveryContainer" class="px-2 py-2 grid grid-cols-1 gap-4 mt-2"></div>
        </div>
        <!-- Main Bar Dsahboard -->
        <div id="manufacturing" class="lg:pl-[190px] flex flex-col md:flex-row gap-4 px-3 overflow-y-scroll thin-scrollbar w-full">
            <div id="live">
                <div class="text-2xl font-bold tracking-tight pd-1 mt-1 text-green-700">
                    <button id="loadBtn">Live Project Details</button>
                </div>
                <div class="w-full rounded-2xl p-1 max-h-[810px] overflow-y-scroll thin-scrollbar bg-gray-100">
                    <div id="liveproject" class="bg-gray-100 p-1 grid grid gap-2 "></div><!-- live and priority projects status -->
                </div>
            </div>
            <!-- priority projects status -->
            <div class="md:flex gap-2 w-full">
                <div class="w-full" id="priority">
                    <div class="p-1">
                        <h1 class="text-2xl text-blue-700 font-bold tracking-tight px-1">Priority Project Status</h1>
                    </div>
                    <div class="py-1 px-2 grid grid-cols-1 md:grid-cols-3 h-[808px] bg-white rounded-2xl w-full">
                        <div id="setprioritystatus"></div><!-- piority items -->
                    </div>
                </div><!-- priority project status end -->
                <!-- Line projects status -->
                <div class="w-full" id="line">
                    <div class="p-1">
                        <h1 class="text-2xl text-blue-700 font-bold tracking-tight px-1">Line Project Status</h1>
                    </div>
                    <div class="py-1 px-2 h-[808px] mb-2 bg-white rounded-2xl w-full">
                        <div id="setlinestatus" class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-2"></div><!-- line items -->
                    </div>
                </div>
            </div><!-- line project status end-->
        </div>
        <div id="projecttype" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <!-- Popup Box -->
            <div class="bg-white p-6 rounded-lg shadow-lg w-80 relative items-center">
                <div class="flex gap-2 justify-between items-center">
                    <h2 class="text-xl font-semibold">Select Project Type</h2>
                    <div class="py-2">
                        <button onclick="closetype()" class="rounded text-white bg-red-500 hover:bg-red-600 px-2 pb-1">
                            x
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-2 items-center justify-center font-semibold text-xl">
                    <button onclick="rework()" class="bg-gray-400 text-white py-2 rounded hover:bg-gray-500">
                        Rework
                    </button>
                    <button onclick="repeatorder()" class="bg-gray-400 text-white py-2 rounded hover:bg-gray-500">
                        Repeat Order
                    </button>
                    <button onclick="newproject()" class="bg-green-500 text-white py-2 rounded hover:bg-green-600">
                        New Project
                    </button>
                </div>
            </div>
        </div>
        <div id="project" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <!-- Popup Box -->
            <div class="bg-white p-6 rounded-lg shadow-lg w-80 relative">
                <h2 class="text-xl font-semibold mb-2">Create Project</h2>
                <div class="p-1 bg-white">
                    <div class="text-sm text-slate-500 flex flex-col">
                        Customer Name
                    </div>
                    <div class="flex gap-2 items-center ">
                        <input id="newcustomername"
                               type="text"
                               readonly="readonly"
                               placeholder="customer name..."
                               class="uppercase w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="showcustomersBtn" class="absolute right-8 mt-4">
                            <span class="material-icons">arrow_drop_down</span>
                        </button>
                    </div>
                    <div id="customerdiv" class="absolute z-50 mt-1 max-h-58 overflow-y-auto hidden w-full flex gap-2 justify-between mt-1">
                        <div class="bg-gray-200 rounded-2xl px-2 py-2 w-5/6">
                            <div id="all_customers" class=" px-2 py-2 space-y-1 w-full bg-white shadow shadow-green-300 rounded-2xl">
                                <div id="deleteCustomer" class="absolute z-50 mt-1 right-8"></div>
                            </div>
                            <div class="flex justify-between w-full">
                                <input id="addcustomername"
                                       type="text"
                                       placeholder="new customer name..."
                                       class="uppercase w-full mt-2 mb-1 border-b border-green-300 rounded-xl px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div id="addnewcustomer" class="mt-2 pl-2 hidden"></div>
                            </div>

                        </div>
                    </div>

                    <input id="projectname"
                           type="text"
                           placeholder="project name..."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="contactperson"
                           type="text"
                           placeholder="Contact Person..."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="parchaseqty"
                           type="number"
                           placeholder="Quantity..."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <label class="text-sm mt-2 text-slate-500 flex flex-col">
                        Expected Delivery Date
                        <input id="toDate" type="date" class="w-full mt-1 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <input id="newjobno"
                           type="text"
                           placeholder="Job No..."
                           class="uppercase w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-2 justify-between mt-3">
                    <button onclick="closeup()" class="bg-red-500 text-white px-7 py-2 rounded mb-4">
                        Close
                    </button>

                    <button onclick="createp()" class="bg-green-500 text-white px-7 py-2 rounded mb-4">
                        Create
                    </button>
                </div>
            </div>
        </div>
        <div id="showrework" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <!-- Popup Box -->
            <div class="bg-white p-6 rounded-lg shadow-lg w-80 relative">
                <div class="flex gap-2 justify-between items-center">
                    <h1 id="reworktype" class="text-xl font-semibold">Rework Project</h1>
                    <h2 id="repeatordertype" class="text-xl font-semibold">Repeat Order Project</h2>
                    <div class="py-2">
                        <button onclick="closetype()" class="rounded text-white bg-red-500 hover:bg-red-600 px-2 pb-1">
                            x
                        </button>
                    </div>
                </div>
                <div class="p-1 bg-white">
                    <div class="flex gap-2 justify-between items-center">
                        <input type="text"
                               id="reworkjobnoInput"
                               placeholder="Enter Job No. . ."
                               class="w-full border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               autocomplete="off" />
                        <button id="reworkjobnoInputBtn" class="absolute right-8 mt-1">
                            <span class="material-icons">arrow_drop_down</span>
                        </button>
                    </div>
                    <!-- Dropdown -->
                    <div id="reworkjobnoList"
                         class="absolute z-50 w-full bg-white border border-gray-300 rounded mt-1 max-h-48 overflow-y-auto hidden">
                    </div>
                    <input type="text"
                           id="customerInput"
                           placeholder="Customer Name. . ."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <input type="text"
                           id="reworkprojectname"
                           placeholder="Project Name. . ."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <input id="reworkcontactperson"
                           type="text"
                           placeholder="Contact Person. . ."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <input id="reworkqty"
                           type="number"
                           placeholder="Quantity. . ."
                           class="w-full mt-2 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="ereworkdate" class="text-sm text-black flex flex-col mt-2">
                        Expected Delivery Date
                        <input id="reworktoDate" type="date" class="w-full mt-1 border border-gray-300 rounded-2xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div id="jobreworkBtn" class="flex gap-2 justify-between w-full hidden"></div>
                </div>
            </div>
        </div>
        <div id="status" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-lg mb-2">
                <div class="bg-gray-100 flex-row">
                    <h2 class="text-xl font-semibold mb-2">Set Project</h2>
                    <button onclick="setline()" class="bg-green-500 text-white px-7 py-2 rounded mb-4">Set to line</button>
                    <button onclick="setpriority()" class="bg-green-500 text-white px-7 py-2 rounded mb-4">Set to priority</button>
                    <button onclick="closeup()" class="bg-white text-black px-7 py-2 rounded mb-4">
                        Close
                    </button>
                </div>
            </div>
        </div>
        <div id="userDropdown" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"></div>
        <div id="vmcDropdown" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"></div>
        <div id="useraccess" class="fixed inset-0 md:p-20 pt-12 lg:pl-[190px] bg-black bg-opacity-50 flex items-center justify-center hidden">
        </div>
        <!-- <footer class="text-center text-xs text-slate-400">AGTEK dashboard • Edit in any editor • No build tools required</footer> footer -->
    </div>
    <script>
        // sidebar toggle (mobile)
        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        }
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }    
        const btnToggleSidebar = document.getElementById('btnToggleSidebar');
        const btnCloseSidebar = document.getElementById('btnCloseSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        btnToggleSidebar.addEventListener('click', openSidebar);
        btnCloseSidebar.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
    </script>
    <!-- Rework Page Script -->
    <script>
        let projects = [];

        const reworkjobnoInput = document.getElementById("reworkjobnoInput");
        const reworkjobnoInputBtn = document.getElementById("reworkjobnoInputBtn");
        const reworkjobnoList = document.getElementById("reworkjobnoList");
        const customerInput = document.getElementById("customerInput");
        const reworkprojectname = document.getElementById("reworkprojectname");
        const reworkcontactperson = document.getElementById("reworkcontactperson");
        const reworkqty = document.getElementById("reworkqty");
        const reworktoDate = document.getElementById("reworktoDate");
        const jobreworkBtn = document.getElementById("jobreworkBtn");
        const ereworkdate = document.getElementById("ereworkdate");
        jobreworkBtn.innerHTML = "";
        // Create rework button
        const rebtn = document.createElement("button");
        rebtn.textContent = "Close";
        rebtn.className =
            "mt-2 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-xl text-white";
        const repeatbtn = document.createElement("button");
        repeatbtn.textContent = "Create";
        repeatbtn.className =
            "mt-2 px-4 py-2 bg-green-500 hover:bg-green-600 rounded-xl text-white";

        jobreworkBtn.appendChild(rebtn);
        jobreworkBtn.appendChild(repeatbtn);
        jobreworkBtn.classList.add("hidden");

        /* Fetch projects once */
        async function loadProjects() {
            try {
                const res = await fetch(`/projects`);;
                projects = await res.json();
            } catch (err) {
                console.error("Failed to load projects", err);
            }
        }
        loadProjects();

        /* Input typing */
        reworkjobnoInput.addEventListener("input", () => {
            const value = reworkjobnoInput.value.trim().toUpperCase();
            reworkjobnoList.innerHTML = "";
           
            if (!value) {
                jobreworkBtn.classList.add("hidden");
                reworkjobnoList.classList.add("hidden");
                clearall();
                document.getElementById("customerInput").readOnly = false;
                document.getElementById("reworkprojectname").readOnly = false;
                document.getElementById("reworkcontactperson").readOnly = false;
                return;
            }

            const matches = projects.filter(p =>
                p.jobno?.toUpperCase().includes(value)
            );

            if (matches.length === 0) {
                reworkjobnoList.classList.add("hidden");
                return;
            }

            matches.forEach(p => {
                const div = document.createElement("div");
                div.textContent = p.jobno;
                div.className =
                    "px-3 py-2 cursor-pointer hover:bg-blue-100";

                div.onclick = () => {
                    choosejobbtn(p);
                };

                reworkjobnoList.appendChild(div);
            });
            reworkjobnoList.classList.remove("hidden");
        });
        reworkjobnoInputBtn.addEventListener("click", () => {
            const value = reworkjobnoInput.value.trim().toUpperCase();
            if (!value) {
                reworkjobnoList.innerHTML = "";
                projects.forEach(p => {
                    const div = document.createElement("div");
                    div.textContent = p.jobno;
                    div.className =
                        "px-3 py-2 cursor-pointer hover:bg-blue-100";
                    reworkjobnoList.appendChild(div);
                    div.onclick = () => {
                        choosejobbtn(p);
                    };
                });
                reworkjobnoList.classList.toggle("hidden");
                return;
            }
            reworkjobnoList.classList.toggle("hidden");

        });

        /* Close dropdown when clicking outside */
        document.addEventListener("click", (e) => {
            if (!reworkjobnoInput.contains(e.target) && !reworkjobnoList.contains(e.target) && !reworkjobnoInputBtn.contains(e.target)) {
                reworkjobnoList.classList.add("hidden");
                //customerDiv.classList.add("hidden");
            }
        });

        function clearall() {
            customerInput.value = "";
            reworkprojectname.value = "";
            reworkcontactperson.value = "";
            reworkqty.value = "";
            reworktoDate.value = "";
        }

        function choosejobbtn(p) {

            reworkjobnoInput.value = p.jobno;
            const id = p.id;
            customerInput.value = p.customer;
            reworkprojectname.value = p.project_name;
            reworkcontactperson.value = p.contact_person;

            // Lock fields
            customerInput.readOnly = true;
            reworkprojectname.readOnly = true;
            reworkcontactperson.readOnly = true;

            reworkjobnoList.classList.add("hidden");
            jobreworkBtn.classList.remove("hidden");

            repeatbtn.onclick = () => {
                console.log("Rework job selected:", p.jobno);
                createReworkProject(p.id, p);
            };

            rebtn.onclick = () => {
                loadAPI();
                closetype();
            };
        }



        function createReworkProject(id, project) {
            if (!id || !project) return alert("No project selected");

            const qty = reworkqty.value;
            const toDate = reworktoDate.value;

            if (!qty || Number(qty) <= 0) return alert("Enter the Quantity");
            if (!toDate) return alert("Enter the Expect Date");

            // Auto add next sequence
            project.project_type = autoAddWithSequence(project.project_type, "type", selectprojecttype);
            project.enquery_date = autoAddWithSequence(project.enquery_date, "enquery_date", new Date().toISOString().slice(0, 10));
            project.quantity = autoAddWithSequence(project.quantity, "quantity", Number(qty));
            project.expected_date = autoAddWithSequence(project.expected_date, "expected_date", toDate);

            // PUT updated project
            fetch(`/projects/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    project_type: project.project_type,
                    enquery_date: project.enquery_date,
                    quantity: project.quantity,
                    expected_date: project.expected_date,
                    overallstatus: "ALLOCATE"
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to update project");
                    return res.json();
                })
                .then(data => {
                    console.log("Updated:", data);
                    alert(`Successfully added ${selectprojecttype}`);
                    //if (selectprojecttype == "REWORK") {
                        updateDnTypeOnly();
                    //}
                    loadAPI();
                })
                .catch(err => console.error(err));

            document.getElementById("showrework").classList.add("hidden");
        }


        async function updateDnTypeOnly() {
            const jobno = reworkjobnoInput.value;

            // 1️⃣ Fetch live_projects rows for this jobno
            const res = await fetch(`/live_projects?jobno=${jobno}`);
            const liveRows = await res.json();

            if (!Array.isArray(liveRows) || liveRows.length === 0) {
                alert("No live rows found for this jobno");
                return;
            }

            const selectedjob = liveRows.filter(p => p.jobno == jobno);

            // 2️⃣ Update each row safely
            for (const row of selectedjob) {
                const updatedData = { ...row };

                Object.keys(row).forEach(key => {
                    if (key.startsWith("dno_") && Array.isArray(row[key])) {
                        updatedData[key] = row[key].map(dnObj => {
                            if (selectprojecttype == "REWORK") {
                                return {
                                    ...dnObj,
                                    dn_type: "OLD"   // 🔥 ONLY CHANGE FOR REWORK
                                };
                            }
                            if (selectprojecttype == "NEW_JOB") {
                                return {
                                    ...dnObj,
                                    dn_type: "NEW"   // 🔥 ONLY CHANGE FOR NEW
                                };
                            }
                            if (selectprojecttype == "REPEAT_ORDER") {
                                return {
                                    ...dnObj,
                                    dn_type: "NEW"   // 🔥 ONLY CHANGE FOR REPEAT_ORDER
                                };
                            }
                        });
                    }
                });

                // 3️⃣ PUT back updated JSON row
                await fetch(`/live_projects/${row.id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedData)
                });
            }

            //alert("dn_type updated to NEW for selected jobno");
        }
        


        // DOM Elements
        const showcustomersBtn = document.getElementById("showcustomersBtn");
        const all_customers = document.getElementById("all_customers");
        const newcustomername = document.getElementById("newcustomername");
        const customerdiv = document.getElementById("customerdiv");
        const addcustomername = document.getElementById("addcustomername");
        const addnewcustomer = document.getElementById("addnewcustomer");

        // Global variables
        let customers = [];

        // Auto-run setup when page loads
        document.addEventListener("DOMContentLoaded", function () {
            loadcustomers();
            setupEventListeners();
        });

        // Setup all event listeners
        function setupEventListeners() {
            // Show customers dropdown
            showcustomersBtn?.addEventListener("click", toggleCustomerDropdown);

            // Search/filter customers
            newcustomername?.addEventListener("input", filterCustomers);

            // Add new customer
            addcustomername?.addEventListener("input", showAddCustomerButton);
        }

        // Load customers from API
        async function loadcustomers() {
            try {
                const res = await fetch(`/customers`);
                if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                customers = await res.json();
            } catch (err) {
                console.error("Failed to load customers", err);
                alert("Failed to load customers. Please try again.");
            }
        }

        // Toggle customer dropdown visibility
        function toggleCustomerDropdown() {
            customerdiv.classList.toggle("hidden");
            if (!customerdiv.classList.contains("hidden")) {
                displayCustomers();
            }
        }

        // Display customers in dropdown
        function displayCustomers() {
            // Clear previous content
            all_customers.innerHTML = "";
            addnewcustomer.innerHTML = "";

            if (customers.length === 0) {
                all_customers.innerHTML = '<div class="px-3 py-2 text-gray-500">No customers found</div>';
                return;
            }

            customers.forEach(customer => {
                createCustomerElement(customer);
            });
        }

        // Create customer element for dropdown
        function createCustomerElement(customer) {
            const customerName = customer.all_customers || customer.name || "Unnamed Customer";

            const customerDiv = document.createElement("div");
            customerDiv.className = "flex justify-between items-center px-3 py-2 cursor-pointer hover:bg-blue-100 hover:border-b border-green-500 rounded-2xl";

            // Customer name
            const nameSpan = document.createElement("span");
            nameSpan.textContent = customerName;
            nameSpan.className = "flex-grow";

            // Delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "-";
            deleteBtn.className = "ml-2 px-2 cursor-pointer hover:bg-red-600 bg-red-500 text-white rounded text-sm";
            deleteBtn.title = "Delete customer";
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteCustomer(customer.id, customerName);
            };

            // Select customer
            customerDiv.onclick = () => {
                newcustomername.value = customerName;
                customerdiv.classList.add("hidden");
            };

            all_customers.appendChild(customerDiv);
            customerDiv.appendChild(nameSpan);
            customerDiv.appendChild(deleteBtn);
        }

        // Filter customers based on search input
        function filterCustomers() {
            const searchValue = newcustomername.value.trim().toUpperCase();

            if (!searchValue) {
                displayCustomers();
                return;
            }

            // Clear and show filtered results
            all_customers.innerHTML = "";
            addnewcustomer.innerHTML = "";

            const filteredCustomers = customers.filter(customer => {
                const customerName = customer.all_customers || customer.name || "";
                return customerName.toUpperCase().includes(searchValue);
            });

            if (filteredCustomers.length === 0) {
                all_customers.innerHTML = '<div class="px-3 py-2 text-gray-500">No matching customers</div>';
                return;
            }

            filteredCustomers.forEach(customer => {
                createCustomerElement(customer);
            });
        }

        // Delete customer function
        async function deleteCustomer(id, name) {
            if (!id) {
                alert("Please select a customer to delete.");
                return;
            }

            if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

            try {
                const response = await fetch(`/customers/${id}`, {
                    method: "DELETE"
                });

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                const result = await response.json();
                alert(result.message || "Customer deleted successfully.");

                // Clear input and reload
                newcustomername.value = "";
                await loadcustomers();
                displayCustomers();

            } catch (err) {
                console.error("Delete error:", err);
                alert("Delete Error: " + (err.message || "Failed to delete customer"));
            }
        }

        // Show add customer button when typing
        function showAddCustomerButton() {
            const value = addcustomername.value.trim().toUpperCase();

            if (!value) {
                addnewcustomer.classList.add("hidden");
                return;
            }

            addnewcustomer.innerHTML = "";

            const addBtn = document.createElement("button");
            addBtn.textContent = "Add";
            addBtn.className = "px-4 py-1 cursor-pointer hover:bg-green-600 bg-green-500 text-white rounded-xl font-medium";
            addBtn.onclick = addNewCustomer;

            addnewcustomer.appendChild(addBtn);
            addnewcustomer.classList.remove("hidden");
        }

        // Add new customer
        async function addNewCustomer() {
            let newname = addcustomername.value.trim();

            if (!newname) {
                alert("Please enter a customer name");
                return;
            }

            // Convert to uppercase
            newname = newname.toUpperCase();

            try {
                const response = await fetch(`/customers`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ all_customers: newname })
                });

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                const result = await response.json();

                // Clear input and show success
                addcustomername.value = "";
                addnewcustomer.classList.add("hidden");
                alert(result.message || "Customer added successfully!");

                // Reload customers
                await loadcustomers();
                displayCustomers();

            } catch (err) {
                console.error("Add customer error:", err);
                alert("Failed to add customer: " + (err.message || "Please try again"));
            }
        }

        // Optional: Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Escape to close dropdown
            if (e.key === 'Escape' && !customerdiv.classList.contains('hidden')) {
                customerdiv.classList.add('hidden');
            }

            // Ctrl/Cmd + F to focus on search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                newcustomername?.focus();
            }
        });
        function normalizef(value) {
            if (typeof value !== "string") return "";
            return value.replace(/_/g, " ").trim().toUpperCase();
        }

        const splitNames = str =>
            str.split("/").map(s => s.trim()).filter(Boolean);



        async function user_access() {
            const useraccess = document.getElementById("useraccess");
            useraccess.classList.remove("hidden");
            useraccess.innerHTML = "";

            employeeheadersfunction();

            cleanHeaders = employeeheaders.filter(h => h.toLowerCase() !== "id");

            const user_display = document.createElement("div");
            user_display.className = "min-w-[270px]";

            user_display.append(createHeader(), createBody(cleanHeaders));
            useraccess.appendChild(user_display);
        }
        function createHeader() {
            const div = document.createElement("div");
            div.className =
                "w-full bg-white h-10 rounded-lg px-3 font-semibold flex gap-2 items-center";
            div.innerHTML = `
            <div id="relativediv" class="relative group pl-6 flex items-center gap-2 w-full">
                <!-- + Button (hidden by default) -->
                <button id="createdepartment" class="px-1 bg-green-500 hover:bg-green-600 text-white rounded absolute left-0 ">+</button>
                <!-- Content -->
                <div class="flex gap-2 w-full items-center">
                    <div class="flex-1 flex justify-between items-center w-full">
                        <h1 id="tabcontent" class="cursor-pointer">
                            Departments
                        </h1>
                        <button id="backspacebtn" class="hidden px-2 h-6 bg-gray-200 rounded">
                            <span class="material-icons">arrow_left</span>
                        </button>
                    </div>
                    <button onclick="closetype()" class="px-3 bg-red-500 text-white rounded">x</button>
                </div>
            </div>`;
            return div;
        }
        function createBody(employeeheaders) {
            const body = document.createElement("div");
            body.className = "flex gap-2 mt-1 bg-slate-100 p-4 rounded-lg";

            const left = createLeftPanel(employeeheaders);
            const right = document.createElement("div");
            right.id = "rightPanel";
            right.className = "hidden bg-white rounded w-[270px] p-2 text-center font-bold";

            body.append(left, right);
            return body;
        }
        function createLeftPanel(employeeheaders) {
            const panel = document.createElement("div");
            panel.id = "leftPanel"
            panel.className = "min-w-[240px] md:w-1/4";

            const btnRow = document.createElement("div");
            btnRow.id = "fieldbtns"
            btnRow.className = "space-y-2 font-semibold";

            const listBox = document.createElement("div");
            listBox.id = "listfieldnames";
            listBox.className = "hidden mt-2 bg-white rounded-lg p-3 space-y-2";

            employeeheaders.forEach(col => {
                const btn = document.createElement("button");
                btn.className = "p-1 bg-green-200 rounded flex gap-2 justify-between w-full";
                /* Title */
                const title = document.createElement("span");
                title.className = "text-sm text-black font-semibold";
                title.textContent =
                    normalizef(col) === "designers_name"
                    ? "Designers"
                    : col.replace(/_name/g, " ");
                /* Icon */
                const icon = document.createElement("span");
                icon.className = "material-icons";
                icon.textContent = "arrow_left";
                /* Click */
                btn.onclick = () => renderEmployees(col, listBox);
                /* Append correctly */
                btn.append(title, icon);
                btnRow.appendChild(btn);
            });

            panel.append(btnRow, listBox, createFieldSetup(employeeheaders, listBox));
            return panel;
        }
        let employeedata = [];

        let employeeheaders = [];

        employeedatafunction();

        employeeheadersfunction();

        async function employeeheadersfunction() {

            employeeheaders = await fetch(`/employee/headers`)
                .then(r => r.json());
        }

        async function employeedatafunction() {

            employeedata = await fetch(`/employee`).then(r => r.json());
        }

        async function renderEmployees(col, listBox) {
            // Back button
            document.getElementById("backspacebtn").onclick = user_access;

            // Header text
            document.getElementById("tabcontent").textContent =
                normalizef(col) === "designers_name"
                    ? "Designers"
                    : col.replace(/_/g, " ");

            // UI visibility
            document.getElementById("listfieldnames").classList.remove("hidden");
            document.getElementById("backspacebtn").classList.remove("hidden");
            document.getElementById("relativediv").classList.remove("pl-6");
            
            document.getElementById("createdepartment").classList.add("hidden");
            document.getElementById("fieldWrap")?.classList.add("hidden");
            document.getElementById("fieldid").classList.add("hidden");
            document.getElementById("fieldbtns").classList.add("hidden");
            document.getElementById("rightPanel").classList.add("hidden");
            //document.getElementById("actionBtn").classList.add("hidden");

            listBox.innerHTML = "";

            // Reload data
            await employeedatafunction();

            // Render rows
            employeedata.forEach(d => {
                const arr = d[col];
                if (!Array.isArray(arr)) return;
                arr.forEach(obj => {
                    const nameKey = Object.keys(obj).find(k => k.startsWith("name"));
                    if (!nameKey) return;

                    listBox.appendChild(
                        createRow(obj[nameKey], col, obj, d.id)
                    );
                });
            });

        }


        function createRow(name, col, data, employeeId) {
            const row = document.createElement("div");
            row.className =
                "flex items-center justify-between px-2 py-1 bg-gray-100 rounded";

            row.innerHTML = `
        <span>${name}</span>
        <div class="flex gap-2">
            <button onclick='openEditEmployee("${col}", ${JSON.stringify(data)}, ${employeeId})'>
                ✏
            </button>
            <button onclick='deleteEmployee("${col}", ${employeeId})'>
                🗑
            </button>
        </div>
    `;
            return row;
        }




        function openEditEmployee(col, data, employeeId) {
            showEditEmployeeForm(col);

            document.getElementById("emp_name").value = data.name ?? "";
            document.getElementById("emp_username").value = data.user_name ?? "";
            document.getElementById("emp_account").value = data.account_type ?? "USER";
            document.getElementById("emp_password").value = data.user_password ?? "";
            document.getElementById("emp_usertype").value = data.user_type ?? "";
            if (!data.user_type) {
                document.getElementById("emp_usertype").classList.add("hidden");
                document.getElementById("emp_process").classList.add("hidden");
                document.getElementById("emp_div").classList.add("hidden");
            }
            document.getElementById("saveBtn").onclick =
                () => updateEmployee(col, employeeId, data.seq);
        }

        let type = [];

        function showEditEmployeeForm(col) {
            const rightPanel = document.getElementById("rightPanel");
            rightPanel.classList.remove("hidden");
            rightPanel.innerHTML = "";

            const wrapper = document.createElement("div");
            wrapper.className = "";

            wrapper.innerHTML = `
            <div id="emp_process" class="text-sm text-gray-700 text-left font-medium">Process</div>
            <div id="emp_div" class="relative flex justify-between mt-2">
            <input id="emp_usertype" class="w-full border rounded-2xl px-2 py-1 font-normal" readonly = true />
            <div id="arrowclick" class="absolute right-2 top-[4px] cursor-pointer">
            <span class="material-icons">arrow_drop_down</span>
            </div>
            </div>
            
            <div class="text-sm text-gray-700 text-left font-medium mt-2">Name</div>
            <input id="emp_name" class="w-full border rounded-2xl px-2 py-1 font-normal"/>

            <div class="text-sm text-gray-700 text-left font-medium mt-2">Username</div>
            <input id="emp_username" class="w-full border rounded-2xl px-2 py-1 font-normal"/>

            <div class="text-sm text-gray-700 text-left font-medium mt-2">Account Type</div>
            <select id="emp_account" class="w-full border rounded-2xl px-2 py-1 font-normal">
                <option value="USER">User</option>
                <option value="ADMIN">Admin</option>
            </select>

            <div class="text-sm text-gray-700 text-left font-medium mt-2">Password</div>
            <input id="emp_password" class="w-full border rounded-2xl px-2 py-1 font-normal"/>

            <button id="saveBtn"
                class="w-full bg-green-500 text-white rounded py-1 mt-3">
                Update
            </button>`;

            
            rightPanel.appendChild(wrapper);
            document.getElementById("arrowclick").onclick = () => {
                const type = "edit";
                selectProcess(col, type);
            }
        }

        function fillEditData(col, data, employeeId) {
            const employee = data.find(emp => emp.seq === employeeId);
            if (!employee) {
                console.error("Employee not found");
                return;
            }

            document.getElementById("emp_usertype").value = employee.account_type;
            document.getElementById("emp_name").value = employee.name;
            document.getElementById("emp_username").value = employee.user_name;
            document.getElementById("emp_account").value = employee.account_type;
            document.getElementById("emp_password").value = employee.user_password;

            document.getElementById("saveBtn").onclick =
                () => updateEmployee(col, employeeId);
        }

        function updateEmployee(col, employeeId, seq) {
            const payload = {
                [col]: [{
                    seq,
                    name: document.getElementById("emp_name").value.trim().toUpperCase(),
                    user_name: document.getElementById("emp_username").value.trim().toUpperCase(),
                    account_type: document.getElementById("emp_account").value,
                    user_password: document.getElementById("emp_password").value
                }]
            };

            const userType = document.getElementById("emp_usertype");
            if (userType && userType.value) {
                payload[col][0].user_type = userType.value.toUpperCase();
            }

            fetch(`/employee/${employeeId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(() => {
                    alert("Employee updated");
                    user_access();
                });
        }

        async function deleteEmployee(col, employeeId) {
            if (!confirm("Delete this employee?")) return;

            await fetch(`/employee/${employeeId}`, {
                method: "DELETE"
            });

            user_access();
        }



        let deptBtnname = null;
let deptCount = 1;

function createFieldSetup(employeeheaders, listBox) {

    /* ---------- HEADER + BUTTONS ---------- */
    const wrap1 = document.createElement("div");
    wrap1.className = "space-y-2";
    wrap1.innerHTML = `
        <h1 class="mt-2 font-bold text-center text-2xl mb-1">Create</h1>
        <div class="flex gap-2 w-full">
            <button id="deptBtn" class="w-full bg-green-500 text-white rounded py-1">
                + Dept
            </button>
            <button id="empBtn" class="w-full bg-green-500 text-white rounded py-1">
                + Employee
            </button>
        </div>
        <div id="departmentList" class="space-y-2 mt-4"></div>
    `;

    /* ---------- INPUT + ADD ---------- */
    const wrap = document.createElement("div");
    wrap.className = "space-y-2";
    wrap.innerHTML = `
        <div class="flex gap-2 items-center">
            <input id="fieldid"
                placeholder="Name..."
                class="w-full border rounded-2xl px-3 py-2 hidden" />
            <button id="deptaddBtn"
                class="bg-green-500 text-white rounded px-3 py-2 hidden">
                +
            </button>
        </div>
    `;
    wrap.id = "fieldWrap";
    wrap.prepend(wrap1);
    
    const actionBox = document.createElement("div");
    actionBox.className = "space-y-2";
    wrap.appendChild(actionBox);

    /* ---------- ELEMENTS ---------- */
    const deptBtn = wrap.querySelector("#deptBtn");
    const empBtn = wrap.querySelector("#empBtn");
    const fieldInput = wrap.querySelector("#fieldid");
    const deptAddBtn = wrap.querySelector("#deptaddBtn");
    const departmentList = wrap.querySelector("#departmentList");

    /* ---------- DEPARTMENT MODE ---------- */
    deptBtn.onclick = () => {
        deptBtnname = "DEPARTMENT";
        fieldInput.value = "";
        document.getElementById("backspacebtn").classList.remove("hidden");
        fieldInput.classList.remove("hidden");
        deptAddBtn.classList.add("hidden");
        deptBtn.classList.add("hidden");
        empBtn.classList.add("hidden");
        fieldInput.focus();
    };

    /* ---------- EMPLOYEE MODE ---------- */
    empBtn.onclick = () => {
        deptBtnname = "EMPLOYEE";
        document.getElementById("backspacebtn").classList.remove("hidden");
        fieldInput.classList.remove("hidden");
        deptBtn.classList.add("hidden");
        empBtn.classList.add("hidden");
        departmentList.classList.add("hidden");
        fieldInput.focus();
    };

    /* ---------- INPUT HANDLER ---------- */
    fieldInput.addEventListener("input", e => {
        const value = e.target.value.trim();

        if (deptBtnname === "DEPARTMENT") {
            deptAddBtn.classList.toggle("hidden", !value);
        }

        if (deptBtnname === "EMPLOYEE") {
            const actionBox = document.getElementById("departmentList");
                actionBox.innerHTML = "";

                // Assume 'data' is the API response
                const data = [
                  { "department_1": "RAJASEKAR" },
                  { "department_2": "DESIGN" }
                ];

                data.forEach(deptObj => {
                    // Get the first value of the object (department name)
                    const deptName = Object.values(deptObj)[0];

                    const btn = document.createElement("button");
                    btn.className = "w-full p-1 bg-gray-200 hover:bg-gray-300 rounded";
                    btn.textContent = deptName;

                    btn.onclick = () => feildcreate("Department", deptName); // or send key if needed
                    actionBox.appendChild(btn);
                });
        }
    });

    /* ---------- ADD DEPARTMENT (FETCH) ---------- */
    deptAddBtn.onclick = async () => {
        const deptName = fieldInput.value.trim().toUpperCase();
        if (!deptName) return;

        const payload = {
            employee_names: null,
            department: [
                { [`department_${deptCount++}`]: deptName }
            ]
        };

        const res = await fetch("/employee", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        fieldInput.value = "";
        deptAddBtn.classList.add("hidden");

        alert("Department added successfully");
    };

    return wrap;
}

        function getFirst(arr) {
            return Array.isArray(arr) && arr.length ? arr[0] : null;
        }


        function getNextSeqFromEmployees(employees, col) {
            let max = 0;

            employees.forEach(e => {
                const item = getFirst(e[col]);
                if (item?.seq) max = Math.max(max, item.seq);
            });

            return max + 1;
        }


        function feildcreate(name, n) {

            /* ---------- Back Button ---------- */
            const backBtn = document.getElementById("backspacebtn");
            backBtn.classList.remove("hidden");
            backBtn.onclick = user_access;

            /* ---------- Panels ---------- */
            const rightPanel = document.getElementById("rightPanel");
            const leftPanel = document.getElementById("leftPanel");

            rightPanel.classList.remove("hidden");
            leftPanel.classList.add("hidden");
            rightPanel.innerHTML = "";

            /* ---------- Field Name ---------- */
            const fieldName = document
                .getElementById("fieldid")
                .value
                .trim()
                .toUpperCase();

            /* ---------- Wrapper ---------- */
            const wrapper = document.createElement("div");
            wrapper.className = "space-y-2";

            /* ---------- Title ---------- */
            const title = document.createElement("div");
            title.className = "font-semibold text-black text-center";
            title.textContent = fieldName;
            /* ---------- Choose Field ---------- */
            const chooseWrapper = document.createElement("div");
            chooseWrapper.className = "relative flex justify-between w-full items-center";

            const chooseInput = document.createElement("input");
            chooseInput.type = "text";
            chooseInput.id = "choosefieldname";
            chooseInput.placeholder = "Select field...";
            chooseInput.className =
                "w-full border rounded-2xl px-3 py-2 font-normal";

            const chooseBtn = document.createElement("button");
            chooseBtn.className = "absolute right-2 top-[9px]";
            chooseBtn.innerHTML = `<span class="material-icons">arrow_drop_down</span>`;
            chooseInput.readOnly = true;
            chooseBtn.onclick = () => selectProcess(name);

            chooseWrapper.append(chooseInput, chooseBtn);

            /* ---------- Username ---------- */
            const userLabel = document.createElement("label");
            userLabel.setAttribute("for", "fieldusername");
            userLabel.className = "text-left block text-sm font-medium text-gray-700";
            userLabel.textContent = "User Name";

            const userInput = document.createElement("input");
            userInput.type = "text";
            userInput.id = "fieldusername";
            userInput.placeholder = "User Name...";
            userInput.className =
                "w-full border rounded-2xl px-3 py-2 font-normal";

            /* ---------- Password ---------- */
            const passLabel = document.createElement("label");
            passLabel.setAttribute("for", "fieldpassword");
            passLabel.className = "text-left block text-sm font-medium text-gray-700";
            passLabel.textContent = "Password";

            const passInput = document.createElement("input");
            passInput.type = "text";
            passInput.id = "fieldpassword";
            passInput.placeholder = "Password...";
            passInput.className =
                "w-full border rounded-2xl px-3 py-2 font-normal";

            /* ---------- Buttons ---------- */
            const btnDiv = document.createElement("div");
            btnDiv.className = "flex justify-between mt-2";

            const createBtn = document.createElement("button");
            createBtn.textContent = "Create";
            createBtn.className =
                "px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded";

            const resetBtn = document.createElement("button");
            resetBtn.textContent = "Reset";
            resetBtn.className =
                "px-3 py-1 bg-gray-400 hover:bg-gray-500 text-white rounded";

            resetBtn.onclick = () => {
                userInput.value = "";
                passInput.value = "";
                chooseInput.value = "";
                userCheckbox.checked = true;
                adminCheckbox.checked = false;
            };

            /* ---------- Account type ---------- */
            const typeLabel = document.createElement("label");
            typeLabel.className = "text-left block text-sm font-medium text-gray-700";
            typeLabel.textContent = "Account Type";

            const typeWrapper = document.createElement("div");
            typeWrapper.className = "flex gap-6 mt-1";

            const accountLabel = document.createElement("label");
            accountLabel.className = "flex items-center gap-2 cursor-pointer";

            const userCheckbox = document.createElement("input");
            userCheckbox.type = "checkbox";

            const userText = document.createElement("span");
            userText.textContent = "User";

            accountLabel.append(userCheckbox, userText);

            const adminLabel = document.createElement("label");
            adminLabel.className = "flex items-center gap-2 cursor-pointer";

            const adminCheckbox = document.createElement("input");
            adminCheckbox.type = "checkbox";

            const adminText = document.createElement("span");
            adminText.textContent = "Admin";

            adminLabel.append(adminCheckbox, adminText);

            if (!userCheckbox.checked && !userCheckbox.checked) userCheckbox.checked = true;

            userCheckbox.onchange = () => {
                if (userCheckbox.checked) adminCheckbox.checked = false;
            };

            adminCheckbox.onchange = () => {
                if (adminCheckbox.checked) userCheckbox.checked = false;
            };

            typeWrapper.append(accountLabel, adminLabel);

            createBtn.onclick = async () => {
                await employeedatafunction();

                const fielduser = userInput.value;
                const accounttype = chooseInput.value;
                const fieldpasswoard = passInput.value;

                const seq = getNextSeqFromEmployees(employeedata, n);

                let choosetype = null;
                if(!adminCheckbox.checked){
                    choosetype = "USER";
                } else choosetype = "ADMIN";
                
                const newEmployee = {
                    seq,
                    name: fieldName,
                    user_name: fielduser,
                    account_type: choosetype,
                    user_password: fieldpasswoard
                };
                
                if (!["designers_name", "drafting", "assembly", "delivery"].includes(n)) {
                    newEmployee.user_type = accounttype;
                }

                const payload = { [n]: [newEmployee] };

                await fetch(`/employee`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                alert("Employee created");
                user_access();
            };


            btnDiv.append(resetBtn, createBtn);

            /* ---------- Assemble ---------- */
            wrapper.append(title);

            if (n !== "designers_name" && n !== "drafting" && n !== "assembly" && n !== "delivery") {
                wrapper.append(chooseWrapper);
            }

            wrapper.append(
                userLabel,
                userInput,
                passLabel,
                passInput,
                typeLabel,
                typeWrapper,
                btnDiv
            );

            rightPanel.appendChild(wrapper);

            document.getElementById("tabcontent").textContent = name.toUpperCase();
        }

        async function selectProcess(name, type) {
            const createType = type;
            let chooseInput = null;
            if (createType === "edit") {
                chooseInput = document.getElementById("emp_usertype");
            } else {
                chooseInput = document.getElementById("choosefieldname");
            }
            
            const productions = await loadProcesses(name);

            console.log(productions); // ✅ array like ["CUTTING","WELDING"]

            // remove old dropdown
            const old = document.getElementById("processList");
            if (old) {
                old.remove();
                return;
            }

            const list = document.createElement("div");
            list.id = "processList";
            list.className =
                "absolute top-7 left-0 w-full bg-white border rounded-xl shadow z-50 max-h-40 overflow-y-auto";

            productions.forEach(p => {
                const item = document.createElement("div");
                item.textContent = p;
                item.className = "px-3 py-2 text-left font-normal hover:bg-blue-100 cursor-pointer";

                item.onclick = () => {
                    chooseInput.value = p;
                    list.remove();
                };
                list.appendChild(item);
            });
            chooseInput.parentElement.appendChild(list);
        }
        async function loadProcesses(name) {
            const procname = name.trim().toUpperCase();

            const res = await fetch(`/processes`);
            const processes = await res.json();

            const productions = [];
            if (name === "production") {
                productions.push("PROGRAM");
            }
            processes
                .filter(p => p.process_type?.toUpperCase() === procname)
                .forEach(emp => {
                    if (!emp.process_name) return;

                    if (Array.isArray(emp.process_name)) {
                        productions.push(...emp.process_name);
                    }
                    else if (typeof emp.process_name === "string") {
                        try {
                            const parsed = JSON.parse(emp.process_name);
                            if (Array.isArray(parsed)) {
                                productions.push(...parsed);
                            } else {
                                productions.push(parsed);
                            }
                        } catch {
                            productions.push(emp.process_name);
                        }
                    }
                });
            return [...new Set(productions)]; // ✅ unique values
        }
    </script>
</body>
</html>










