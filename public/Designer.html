<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="pageTitle1">AGTEK: Designer Projects</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen text-slate-900">

<header class="fixed inset-x-0 top-0 bg-white border-b z-40">
  <div class="max-w-10xl mx-auto px-4 py-3 flex justify-between">
    <div>
      <div class="text-xl font-bold text-green-600">AGTEK</div>
      <div id="designerCard" class="text-sm text-slate-700"></div>
    </div>
    <div class="flex gap-3">
      <button id="btnRefreshAll" class="px-3 py-1 bg-sky-600 text-white rounded">Refresh</button>
      <button id="logoutBtn" class="px-3 py-1 bg-red-500 text-white rounded">Logout</button>
    </div>
  </div>
</header>

<main class="pt-20 max-w-10xl mx-auto px-4">
  <div class="p-3 bg-green-200 rounded-xl w-1/4 mb-4">
    <h1 id="pageTitle" class="text-xl font-bold"></h1>
    <p id="infoLine" class="text-sm"></p>
  </div>
  <div id="projectsContainer" class="grid md:grid-cols-3 gap-3"></div>
</main>

<script>
const API = { projects: "/projects" };
const DESIGNER_NAME = localStorage.getItem("selectedDesigner");
document.getElementById("designerCard").textContent = DESIGNER_NAME;
document.getElementById("pageTitle").textContent = `Projects for ${DESIGNER_NAME}`;

document.getElementById("btnRefreshAll").onclick = loadProjectsForDesigner;

async function loadProjectsForDesigner() {
  const res = await fetch(API.projects);
  const projects = await res.json();
  const assigned = projects.filter(p => p.overallstatus === DESIGNER_NAME);
  document.getElementById("infoLine").textContent = `${assigned.length} project(s)`;
  const box = document.getElementById("projectsContainer");
  box.innerHTML = "";
  assigned.forEach(p => box.appendChild(buildProjectCard(p)));
}

function buildProjectCard(p) {
  const card = document.createElement("div");
  card.className = "bg-white p-4 rounded-xl shadow";

  const stageArray = Array.isArray(p.design_stages) ? p.design_stages : [];

  const statusBox = document.createElement("div");
  statusBox.className = "mt-2 p-2 bg-yellow-100 rounded text-sm";

  const btnRow = document.createElement("div");
  btnRow.className = "flex gap-2 mt-3";

  const startBtn = button("Start Design", "bg-yellow-600");
  const plotBtn = button("Add Check Plot", "bg-blue-600");
  const confirmBtn = button("Confirm", "bg-indigo-600");
  const draftBtn = button("Move to Drafting", "bg-green-700 hidden");

  function getCurrentCycle() {
    return stageArray[stageArray.length - 1];
  }

  function updateUI() {
    btnRow.innerHTML = "";
    const cycle = getCurrentCycle();

    if (!cycle) {
      btnRow.append(startBtn);
      statusBox.textContent = "Status: Not Started";
      return;
    }

    const stages = Object.keys(cycle).filter(k => k.startsWith("stage")).sort();
    const lastStage = cycle[stages[stages.length - 1]];
    statusBox.textContent = "Status: " + lastStage;

    if (lastStage.includes("confirmed")) {
      btnRow.append(draftBtn);
    } else {
      btnRow.append(plotBtn, confirmBtn);
    }
  }

  startBtn.onclick = async () => {
    stageArray.push({ sec: stageArray.length + 1, stage1: "Design Start" });
    await save();
  };

  plotBtn.onclick = async () => {
    const cycle = getCurrentCycle();
    const idx = Object.keys(cycle).filter(k => k.startsWith("stage")).length + 1;
    cycle["stage" + idx] = `Check Plot ${idx - 1}`;
    await save();
  };

  confirmBtn.onclick = async () => {
    const cycle = getCurrentCycle();
    const idx = Object.keys(cycle).filter(k => k.startsWith("stage")).length + 1;
    const today = new Date().toISOString().split("T")[0];
    cycle["stage" + idx] = `Design confirmed at (${today})`;
    await save();
  };

  async function save() {
    await fetch(`${API.projects}/${p.id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ design_stages: stageArray })
    });
    updateUI();
  }

  card.innerHTML = `<div class="font-bold">${p.jobno} - ${p.project_name}</div>`;
  card.append(statusBox, btnRow);
  updateUI();
  return card;
}

function button(text, cls) {
  const b = document.createElement("button");
  b.textContent = text;
  b.className = `px-3 py-1 text-white rounded ${cls}`;
  return b;
}

loadProjectsForDesigner();
</script>
</body>
</html>
