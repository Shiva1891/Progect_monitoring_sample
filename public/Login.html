<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="allocate" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">

        <div class="bg-green-500 p-8 rounded-2xl shadow-xl w-96">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold">User</h2>
                <div class="py-2">
                    <button onclick="cancel()" class="rounded text-white bg-red-500 hover:bg-red-400 px-2 pb-1">X</button>
                </div>
            </div>

            <!-- SELECT LOGIN TYPE -->
            <div class="mb-4">
                <div id="loginType" class="w-full mt-2 p-2 rounded-lg bg-white text-xl font-bold">Allocate</div>
            </div>

            <!-- PASSWORD -->
            <div class="mb-6">
                <input id="password" type="password" autofocus class="w-full p-3 rounded-lg" placeholder="Password">
            </div>

            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700">
                Login
            </button>

        </div>
    </div>

    <script>
        let name = null;
        let adminpassword = null;
        let account = null;
        function loadAll() {
            const tempname = localStorage.getItem("selectedDesigner");

    
            // If Allocate selected
    
            if (tempname === "Allocate" || tempname === "Drafting") {
        
                name = tempname;
        
                document.getElementById("loginType").textContent = tempname;
        
                return;
    
            }

    
            fetch("/employee")
        
                .then(res => res.json())
        
                .then(data => {

            
                    let matchedUser = null;

            
                    const allNames = [];
                    const normalize = v =>
                        v?.replace(/"/g, "").trim().toUpperCase();
                    
                    data.forEach(emp => {
                
                        if (!Array.isArray(emp.employee_names)) return;

                
                        emp.employee_names.forEach(p => {
                    
                            if (p.name === tempname) {
                        
                                matchedUser = p;
                    
                            }
                
                        });
            
                    });

            
                    // If user found
            
                    if (matchedUser) {
                
                        document.getElementById("loginType").textContent = matchedUser.name;
                
                        name = matchedUser.name;
                
                        adminpassword = matchedUser.user_password;
                
                        account = matchedUser.account_type;
            
                    } else {
                
                        console.warn("No matching user found");
            
                    }
       
                })
        
                .catch(err => console.error("Employee load error:", err));

        }

        /* ----------------------------------
              USER PASSWORDS ONLY
        ----------------------------------- */
        const users = {
            allocate: { password: "2025", role: "allocate" },

            draftingPasswoard: "2025"
        };

        /* ----------------------------------
              PRESS ENTER â†’ LOGIN
        ----------------------------------- */
        document.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                login();
            }
        });

        /* ----------------------------------
                     LOGIN
        ----------------------------------- */
        function login() {
            const type = document.getElementById("loginType").textContent;
            const pass = document.getElementById("password").value;
            //Alocate Login
            if (type === "Allocate") {
                if (pass !== users.allocate.password) {
                    alert("Invalid allocate password");
                    return;
                }
                window.open("allocate", "_blank");
                history.go(-1);
                return;
            }
            //Drafting Login
            if (type === "Drafting") {
                if (pass !== users.allocate.password) {
                    alert("Invalid allocate password");
                    return;
                }
                window.open("drafting", "_blank");
                history.go(-1);
                return;
            }
                //Designer Login
            else {
                if (!name) {
                    alert("Designer not selected on Dashboard. Please select designer first.");
                    window.location.href = "dashboard";
                    return;
                }
                if (pass !== adminpassword) {
                    alert("Invalid designer password");
                    return;
                }
                // Redirect to designer page with name
                window.open(`designer?name=${encodeURIComponent(name)}`, "_blank");
                history.go(-1);
            }
        }

        /* ----------------------------------
                     CANCEL BUTTON
        ----------------------------------- */

        function notifyDashboardRefresh() {
            localStorage.setItem("REFRESH_DASHBOARD", Date.now());
        }

        function cancel() {
            //const type = document.getElementById("loginType").textContent;
            //if (type === "Allocate" || type === "Drafting" || type === "") {
            //    history.go(-1);
            //    try { window.close(); } catch (_) { history.go(-1); }
            //} else {
            //    window.close();
            //}
            history.go(-1);
            notifyDashboardRefresh();
        }

        window.loadAll()

    </script>

</body>
</html>







